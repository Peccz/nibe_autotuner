<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nibe Autotuner V4.0 - Digital Twin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .card-title { color: #94a3b8; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- HEADER: System Intent -->
    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold mb-1 tracking-tight">Huset <span class="text-blue-400">Autotuner</span></h1>
            <div class="flex items-center gap-2 text-sm text-slate-400">
                <span id="status-badge" class="w-2 h-2 rounded-full bg-green-500"></span>
                <span id="intent-text">Analyserar väder och priser...</span>
            </div>
        </div>
        <div class="text-right">
            <div class="card-title">Besparing 24h</div>
            <div class="text-2xl font-bold text-green-400" id="savings-val">-- SEK</div>
        </div>
    </div>

    <!-- LAYER 1: Core Metrics (The Moment) -->
    <div class="max-w-6xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="glass p-4 rounded-2xl">
            <div class="card-title">Inne (Nere)</div>
            <div class="text-2xl font-bold" id="temp-down">--°C</div>
            <div class="text-xs text-slate-500 mt-1" id="hum-down">Fukt: --%</div>
        </div>
        <div class="glass p-4 rounded-2xl border-l-4 border-blue-500">
            <div class="card-title">Inne (Dexter)</div>
            <div class="text-2xl font-bold" id="temp-dexter">--°C</div>
            <div class="text-xs text-blue-400 mt-1">Hög precision</div>
        </div>
        <div class="glass p-4 rounded-2xl">
            <div class="card-title">Ute / Vind</div>
            <div class="text-2xl font-bold" id="temp-out">--°C</div>
            <div class="text-xs text-slate-500 mt-1" id="wind-speed">Vind: -- m/s</div>
        </div>
        <div class="glass p-4 rounded-2xl">
            <div class="card-title">Elpris</div>
            <div class="text-2xl font-bold text-yellow-400" id="price-now">-- öre</div>
            <div id="price-trend" class="text-xs mt-1">--</div>
        </div>
    </div>

    <!-- LAYER 2: The Timeline (The Future) -->
    <div class="max-w-6xl mx-auto glass p-6 rounded-3xl mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold">Prediktiv Tidslinje (24h)</h2>
            <div class="flex gap-4 text-xs">
                <span class="flex items-center gap-1"><span class="w-3 h-1 bg-blue-400"></span> Nere</span>
                <span class="flex items-center gap-1"><span class="w-3 h-1 bg-purple-400"></span> Dexter</span>
            </div>
        </div>
        <div class="h-64 w-full">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>

    <!-- LAYER 3: The Scientist & Guards -->
    <div class="max-w-6xl mx-auto grid md:grid-cols-3 gap-6">
        <!-- Machine Health -->
        <div class="glass p-6 rounded-3xl">
            <h3 class="card-title mb-4">Pumpens Hälsa</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm">Förångare (BT16)</span>
                    <span id="evap-temp" class="font-mono">--°C</span>
                </div>
                <div id="frost-guard" class="hidden bg-blue-900/50 text-blue-200 text-xs p-2 rounded-lg flex items-center gap-2">
                    <span class="status-pulse">❄️</span> Frostskydd aktivt - Forcerar luft
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm">Framledning (BT2)</span>
                    <span id="supply-temp" class="font-mono text-blue-400">--°C</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm">Kompressor</span>
                    <span id="comp-hz" class="font-mono">-- Hz</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm">Ventilation</span>
                    <span id="fan-speed" class="font-mono">-- %</span>
                </div>
            </div>
        </div>

        <!-- The Scientist (Learning) -->
        <div class="glass p-6 rounded-3xl col-span-2">
            <h3 class="card-title mb-4">The Scientist - Inlärning</h3>
            <div class="grid grid-cols-2 gap-4" id="tuning-params">
                <!-- Params injected by JS -->
            </div>
            <div class="mt-4 pt-4 border-t border-white/10 text-xs text-slate-400 italic">
                AI kalibrerar om husmodellen varje natt kl 03:00 baserat på verkligt beteende.
            </div>
        </div>
    </div>

    <script>
        async function updateDashboard() {
            const res = await fetch('/api/v4/dashboard');
            const data = await res.json();
            const s = data.status;

            // Update Metrics
            document.getElementById('temp-down').innerText = s.indoor_downstairs.toFixed(2) + '°C';
            document.getElementById('temp-dexter').innerText = s.indoor_dexter.toFixed(2) + '°C';
            document.getElementById('temp-out').innerText = s.outdoor_temp.toFixed(1) + '°C';
            document.getElementById('hum-down').innerText = 'Fukt: ' + (s.indoor_humidity || '--') + '%';
            document.getElementById('price-now').innerText = (s.current_price * 100).toFixed(0) + ' öre';
            document.getElementById('supply-temp').innerText = s.supply_temp.toFixed(1) + '°C';
            document.getElementById('evap-temp').innerText = (s.evaporator_temp || '--') + '°C';
            document.getElementById('comp-hz').innerText = s.compressor_freq.toFixed(0) + ' Hz';
            document.getElementById('fan-speed').innerText = s.fan_speed + '%';
            document.getElementById('savings-val').innerText = data.recent_savings.toFixed(2) + ' SEK';

            if(s.is_frost_guard_active) document.getElementById('frost-guard').classList.remove('hidden');

            // Update Tuning
            const tuningDiv = document.getElementById('tuning-params');
            tuningDiv.innerHTML = '';
            const importantParams = ['thermal_leakage', 'rad_efficiency', 'wind_direction_west_factor', 'thermal_inertia_lag'];
            importantParams.forEach(key => {
                if(data.tuning[key]) {
                    tuningDiv.innerHTML += `
                        <div class="bg-white/5 p-3 rounded-xl">
                            <div class="text-[10px] text-slate-500 uppercase">${key.replace(/_/g, ' ')}</div>
                            <div class="text-lg font-semibold">${data.tuning[key].toFixed(4)}</div>
                        </div>
                    `;
                }
            });

            renderChart(data.plan);
        }

        let chart;
        function renderChart(plan) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            const labels = plan.map(p => new Date(p.time).getHours() + ':00');
            
            if(chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Dexter Sim',
                            data: plan.map(p => p.temp_sim_dexter),
                            borderColor: '#a855f7',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Nere Sim',
                            data: plan.map(p => p.temp_sim_down),
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Pris',
                            data: plan.map(p => p.price * 10),
                            type: 'bar',
                            backgroundColor: plan.map(p => p.action === 'RUN' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(255,255,255,0.05)'),
                            yAxisID: 'yPrice'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 18, max: 23, grid: { color: 'rgba(255,255,255,0.05)' } },
                        yPrice: { position: 'right', display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        updateDashboard();
        setInterval(updateDashboard, 60000);
    </script>
</body>
</html>
