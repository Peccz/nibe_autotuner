{% extends "base.html" %}

{% block title %}Visualiseringar - Nibe Autotuner{% endblock %}

{% block extra_css %}
<style>
.chart-section {
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding: 12px 16px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #1e4d6e 100%);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.section-icon {
    font-size: 28px;
    line-height: 1;
}

.section-info {
    flex: 1;
}

.section-title {
    font-size: 18px;
    font-weight: 700;
    color: white;
    margin: 0;
    line-height: 1.2;
}

.section-subtitle {
    font-size: 12px;
    color: rgba(255,255,255,0.85);
    margin: 2px 0 0 0;
}

.chart-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.05);
}

.chart-card.featured {
    border: 2px solid var(--primary-color);
    box-shadow: 0 4px 12px rgba(45, 95, 142, 0.2);
}

.chart-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.chart-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 12px;
    background: var(--primary-color);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
}

.chart-container {
    position: relative;
    height: 250px;
    margin-bottom: 8px;
}

.chart-container.large {
    height: 300px;
}

.chart-description {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 8px;
    padding: 8px;
    background: rgba(33, 150, 243, 0.05);
    border-radius: 6px;
    border-left: 3px solid var(--primary-color);
}

.time-selector-wrapper {
    background: var(--card-bg);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}

.time-selector-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}
</style>
{% endblock %}

{% block content %}
<!-- Time period selector -->
<div class="time-selector-wrapper">
    <div class="time-selector-label">
        <span>‚è±Ô∏è</span>
        <span>V√§lj tidsperiod</span>
    </div>
    <select id="timePeriod" class="form-select" onchange="loadAllCharts()">
        <option value="1">Senaste timmen</option>
        <option value="6">Senaste 6 timmarna</option>
        <option value="24" selected>Senaste 24 timmarna</option>
        <option value="72">Senaste 3 dagarna</option>
        <option value="168">Senaste veckan</option>
    </select>
</div>

<!-- Loading indicator -->
<div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Laddar grafer...</p>
</div>

<!-- Error message -->
<div id="error" class="error" style="display: none;"></div>

<!-- Charts -->
<div id="chartsContainer" style="display: none;">

    <!-- PERFORMANCE ANALYSIS -->
    <div class="chart-section">
        <div class="section-header">
            <span class="section-icon">‚ö°</span>
            <div class="section-info">
                <h2 class="section-title">Prestandaanalys</h2>
                <p class="section-subtitle">Effektivitet och verkningsgrad</p>
            </div>
        </div>

        <div class="chart-card featured">
            <h3 class="chart-title">
                <span>üîÑ Pump, Delta T & COP</span>
                <span class="chart-badge">NYHET</span>
            </h3>
            <div class="chart-container large">
                <canvas id="pumpDeltaCopChart"></canvas>
            </div>
            <div class="chart-description">
                üí° <strong>Se sambanden:</strong> Cirkulationspumpens hastighet p√•verkar Delta T, som i sin tur p√•verkar COP. Optimal drift = l√•g pump + h√∂gt Delta T + h√∂gt COP.
            </div>
        </div>

        <div class="chart-card featured">
            <h3 class="chart-title">
                <span>‚ö° COP & Utetemperatur</span>
                <span class="chart-badge">NYHET</span>
            </h3>
            <div class="chart-container large">
                <canvas id="copOutdoorChart"></canvas>
            </div>
            <div class="chart-description">
                üí° <strong>Viktigt samband:</strong> COP sjunker n√§r det blir kallare ute. Detta √§r normalt - men ju h√∂gre COP vid given utetemperatur, desto b√§ttre!
            </div>
        </div>
    </div>

    <!-- TEMPERATURE MONITORING -->
    <div class="chart-section">
        <div class="section-header">
            <span class="section-icon">üå°Ô∏è</span>
            <div class="section-info">
                <h2 class="section-title">Temperatur√∂vervakning</h2>
                <p class="section-subtitle">Inne, ute och v√§rmesystem</p>
            </div>
        </div>

        <div class="chart-card featured">
            <h3 class="chart-title">
                <span>üå°Ô∏è Inne- & Utetemperatur</span>
                <span class="chart-badge">NYHET</span>
            </h3>
            <div class="chart-container large">
                <canvas id="indoorOutdoorChart"></canvas>
            </div>
            <div class="chart-description">
                üí° <strong>Komfortkontroll:</strong> Inomhustemperaturen ska vara stabil trots v√§xlande utetemperatur. Stora sv√§ngningar = justera v√§rmekurvan.
            </div>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">üî• Fram & Returtemperatur</h3>
            <div class="chart-container">
                <canvas id="supplyReturnChart"></canvas>
            </div>
            <div class="chart-description">
                üí° Skillnaden mellan fram och retur = Delta T. Optimalt: 5-7¬∞C f√∂r b√§sta COP.
            </div>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">üíß Varmvattentemperatur</h3>
            <div class="chart-container">
                <canvas id="hotWaterChart"></canvas>
            </div>
            <div class="chart-description">
                üí° Ska vara minst 50¬∞C f√∂r att f√∂rhindra legionella, men inte f√∂r h√∂gt (energisl√∂seri).
            </div>
        </div>
    </div>

    <!-- SYSTEM STATUS -->
    <div class="chart-section">
        <div class="section-header">
            <span class="section-icon">‚öôÔ∏è</span>
            <div class="section-info">
                <h2 class="section-title">Systemstatus</h2>
                <p class="section-subtitle">Komponenter och drift</p>
            </div>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">‚öôÔ∏è Kompressorfrekvens</h3>
            <div class="chart-container">
                <canvas id="compressorChart"></canvas>
            </div>
            <div class="chart-description">
                üí° Kompressorn ska k√∂ra j√§mnt och l√•ngsamt (20-40 Hz) f√∂r b√§sta effektivitet. Mycket p√•/av = f√∂rs√§mrad COP.
            </div>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">üå°Ô∏è Utomhustemperatur</h3>
            <div class="chart-container">
                <canvas id="outdoorChart"></canvas>
            </div>
            <div class="chart-description">
                üí° Referenstemperatur f√∂r systemets styrning. Avg√∂r framledningstemperatur via v√§rmekurvan.
            </div>
        </div>

        <div class="chart-card">
            <h3 class="chart-title">üè† Inomhustemperatur</h3>
            <div class="chart-container">
                <canvas id="indoorChart"></canvas>
            </div>
            <div class="chart-description">
                üí° B√∂rv√§rde: 20-22¬∞C. Justeras med kurvjustering om temperaturen inte √§r r√§tt.
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
let charts = {};

const chartConfig = {
    outdoor: {
        label: 'Utomhus',
        borderColor: '#2196f3',
        backgroundColor: 'rgba(33, 150, 243, 0.1)',
        unit: '¬∞C'
    },
    indoor: {
        label: 'Inomhus',
        borderColor: '#4caf50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        unit: '¬∞C'
    },
    supply: {
        label: 'Framledning',
        borderColor: '#f44336',
        backgroundColor: 'rgba(244, 67, 54, 0.1)',
        unit: '¬∞C'
    },
    return: {
        label: 'Retur',
        borderColor: '#ff9800',
        backgroundColor: 'rgba(255, 152, 0, 0.1)',
        unit: '¬∞C'
    },
    compressor: {
        label: 'Frekvens',
        borderColor: '#9c27b0',
        backgroundColor: 'rgba(156, 39, 176, 0.1)',
        unit: ' Hz'
    },
    hot_water: {
        label: 'Varmvatten',
        borderColor: '#ff5722',
        backgroundColor: 'rgba(255, 87, 34, 0.1)',
        unit: '¬∞C'
    },
    pump_speed: {
        label: 'Pump',
        borderColor: '#00bcd4',
        backgroundColor: 'rgba(0, 188, 212, 0.1)',
        unit: '%'
    },
    delta_t: {
        label: 'Delta T',
        borderColor: '#ff9800',
        backgroundColor: 'rgba(255, 152, 0, 0.1)',
        unit: '¬∞C'
    },
    cop: {
        label: 'COP',
        borderColor: '#4caf50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        unit: ''
    }
};

function createChart(canvasId, type, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas element not found: ${canvasId}`);
        return null;
    }
    const ctx = canvas.getContext('2d');

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: config.label,
                data: [],
                borderColor: config.borderColor,
                backgroundColor: config.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(1) + config.unit;
                        },
                        title: function(context) {
                            const date = new Date(context[0].label);
                            return date.toLocaleString('sv-SE', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 6,
                        font: {
                            size: 10
                        },
                        callback: function(value, index, ticks) {
                            // Show simplified time labels
                            const label = this.getLabelForValue(value);
                            if (label) {
                                const date = new Date(label);
                                const hours = date.getHours().toString().padStart(2, '0');
                                const mins = date.getMinutes().toString().padStart(2, '0');
                                return `${hours}:${mins}`;
                            }
                            return label;
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    ticks: {
                        callback: function(value) {
                            return value + config.unit;
                        },
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

function createDualChart(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas element not found: ${canvasId}`);
        return null;
    }
    const ctx = canvas.getContext('2d');

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Framledning',
                    data: [],
                    borderColor: chartConfig.supply.borderColor,
                    backgroundColor: chartConfig.supply.backgroundColor,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: 'Retur',
                    data: [],
                    borderColor: chartConfig.return.borderColor,
                    backgroundColor: chartConfig.return.backgroundColor,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '¬∞C';
                        },
                        title: function(context) {
                            const date = new Date(context[0].label);
                            return date.toLocaleString('sv-SE', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: 6,
                        font: {
                            size: 10
                        },
                        callback: function(value, index, ticks) {
                            // Show simplified time labels
                            const label = this.getLabelForValue(value);
                            if (label) {
                                const date = new Date(label);
                                const hours = date.getHours().toString().padStart(2, '0');
                                const mins = date.getMinutes().toString().padStart(2, '0');
                                return `${hours}:${mins}`;
                            }
                            return label;
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    ticks: {
                        callback: function(value) {
                            return value + '¬∞C';
                        },
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    });
}

function createMultiAxisChart(canvasId, datasets, yAxes) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas element not found: ${canvasId}`);
        return null;
    }
    const ctx = canvas.getContext('2d');

    // Build scales configuration
    const scales = {
        x: {
            ticks: {
                maxTicksLimit: 6,
                font: {
                    size: 10
                },
                callback: function(value, index, ticks) {
                    const label = this.getLabelForValue(value);
                    if (label) {
                        const date = new Date(label);
                        const hours = date.getHours().toString().padStart(2, '0');
                        const mins = date.getMinutes().toString().padStart(2, '0');
                        return `${hours}:${mins}`;
                    }
                    return label;
                }
            },
            grid: {
                display: false
            }
        }
    };

    // Add Y axes
    yAxes.forEach((axis, index) => {
        scales[axis.id] = {
            type: 'linear',
            position: axis.position,
            ticks: {
                callback: function(value) {
                    return value + axis.unit;
                },
                font: {
                    size: 10
                }
            },
            grid: {
                color: index === 0 ? 'rgba(0, 0, 0, 0.05)' : 'rgba(0, 0, 0, 0)',
                drawOnChartArea: index === 0
            },
            title: {
                display: true,
                text: axis.label,
                font: {
                    size: 11
                }
            }
        };
    });

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const axis = yAxes.find(a => a.id === context.dataset.yAxisID);
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + (axis ? axis.unit : '');
                        },
                        title: function(context) {
                            const date = new Date(context[0].label);
                            return date.toLocaleString('sv-SE', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                }
            },
            scales: scales
        }
    });
}

async function loadChartData(chartType, chartInstance) {
    if (!chartInstance) {
        console.warn(`Skipping ${chartType} chart - instance is null`);
        return;
    }

    const hours = document.getElementById('timePeriod').value;

    try {
        const response = await fetch(`/api/chart/${chartType}?hours=${hours}`);
        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error);
        }

        const data = result.data;

        // Update chart data
        chartInstance.data.labels = data.labels;
        chartInstance.data.datasets[0].data = data.values;
        chartInstance.update('none');

    } catch (err) {
        console.error(`Error loading ${chartType} chart:`, err);
        throw err;
    }
}

async function loadAllCharts() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const container = document.getElementById('chartsContainer');

    loading.style.display = 'block';
    error.style.display = 'none';
    container.style.display = 'none';

    try {
        // Load all chart data
        await Promise.all([
            loadChartData('outdoor', charts.outdoor),
            loadChartData('indoor', charts.indoor),
            loadChartData('compressor', charts.compressor),
            loadChartData('hot_water', charts.hotWater)
        ]);

        // Load supply and return for dual chart
        const hours = document.getElementById('timePeriod').value;

        const [supplyRes, returnRes] = await Promise.all([
            fetch(`/api/chart/supply?hours=${hours}`),
            fetch(`/api/chart/return?hours=${hours}`)
        ]);

        const supplyData = await supplyRes.json();
        const returnData = await returnRes.json();

        if (charts.supplyReturn && supplyData.success && returnData.success) {
            charts.supplyReturn.data.labels = supplyData.data.labels;
            charts.supplyReturn.data.datasets[0].data = supplyData.data.values;
            charts.supplyReturn.data.datasets[1].data = returnData.data.values;
            charts.supplyReturn.update('none');
        }

        // Load data for new multi-axis charts
        const [pumpRes, deltaRes, copRes] = await Promise.all([
            fetch(`/api/chart/pump_speed?hours=${hours}`),
            fetch(`/api/chart/delta_t?hours=${hours}`),
            fetch(`/api/chart/cop?hours=${hours}`)
        ]);

        const pumpData = await pumpRes.json();
        const deltaData = await deltaRes.json();
        const copData = await copRes.json();

        // Update Pump, Delta T & COP chart
        if (charts.pumpDeltaCop && pumpData.success && deltaData.success && copData.success) {
            charts.pumpDeltaCop.data.labels = pumpData.data.labels;
            charts.pumpDeltaCop.data.datasets[0].data = pumpData.data.values;
            charts.pumpDeltaCop.data.datasets[1].data = deltaData.data.values;
            charts.pumpDeltaCop.data.datasets[2].data = copData.data.values;
            charts.pumpDeltaCop.update('none');
        }

        // Reuse already loaded data for Indoor & Outdoor chart
        const indoorRes = await fetch(`/api/chart/indoor?hours=${hours}`);
        const outdoorRes = await fetch(`/api/chart/outdoor?hours=${hours}`);
        const indoorData = await indoorRes.json();
        const outdoorData = await outdoorRes.json();

        if (charts.indoorOutdoor && indoorData.success && outdoorData.success) {
            charts.indoorOutdoor.data.labels = indoorData.data.labels;
            charts.indoorOutdoor.data.datasets[0].data = indoorData.data.values;
            charts.indoorOutdoor.data.datasets[1].data = outdoorData.data.values;
            charts.indoorOutdoor.update('none');
        }

        // Update COP & Outdoor chart
        if (charts.copOutdoor && copData.success && outdoorData.success) {
            charts.copOutdoor.data.labels = copData.data.labels;
            charts.copOutdoor.data.datasets[0].data = copData.data.values;
            charts.copOutdoor.data.datasets[1].data = outdoorData.data.values;
            charts.copOutdoor.update('none');
        }

        container.style.display = 'block';

    } catch (err) {
        error.textContent = '‚ùå Fel vid laddning av grafer: ' + err.message;
        error.style.display = 'block';
        console.error('Error loading charts:', err);
    } finally {
        loading.style.display = 'none';
    }
}

// Initialize charts on page load
function initCharts() {
    // Ensure Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded yet, retrying...');
        setTimeout(initCharts, 100);
        return;
    }

    // Create all charts
    charts.outdoor = createChart('outdoorChart', 'outdoor', chartConfig.outdoor);
    charts.indoor = createChart('indoorChart', 'indoor', chartConfig.indoor);
    charts.supplyReturn = createDualChart('supplyReturnChart');
    charts.compressor = createChart('compressorChart', 'compressor', chartConfig.compressor);
    charts.hotWater = createChart('hotWaterChart', 'hot_water', chartConfig.hot_water);

    // Create new multi-axis charts
    // Pump, Delta T & COP chart
    charts.pumpDeltaCop = createMultiAxisChart('pumpDeltaCopChart',
        [
            {
                label: 'Pump',
                data: [],
                borderColor: chartConfig.pump_speed.borderColor,
                backgroundColor: chartConfig.pump_speed.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1'
            },
            {
                label: 'Delta T',
                data: [],
                borderColor: chartConfig.delta_t.borderColor,
                backgroundColor: chartConfig.delta_t.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y2'
            },
            {
                label: 'COP',
                data: [],
                borderColor: chartConfig.cop.borderColor,
                backgroundColor: chartConfig.cop.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y3'
            }
        ],
        [
            { id: 'y1', position: 'left', unit: '%', label: 'Pump (%)' },
            { id: 'y2', position: 'right', unit: '¬∞C', label: 'Delta T (¬∞C)' },
            { id: 'y3', position: 'right', unit: '', label: 'COP' }
        ]
    );

    // Indoor & Outdoor Temperature chart
    charts.indoorOutdoor = createMultiAxisChart('indoorOutdoorChart',
        [
            {
                label: 'Inne',
                data: [],
                borderColor: chartConfig.indoor.borderColor,
                backgroundColor: chartConfig.indoor.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1'
            },
            {
                label: 'Ute',
                data: [],
                borderColor: chartConfig.outdoor.borderColor,
                backgroundColor: chartConfig.outdoor.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1'
            }
        ],
        [
            { id: 'y1', position: 'left', unit: '¬∞C', label: 'Temperatur (¬∞C)' }
        ]
    );

    // COP & Outdoor Temperature chart
    charts.copOutdoor = createMultiAxisChart('copOutdoorChart',
        [
            {
                label: 'COP',
                data: [],
                borderColor: chartConfig.cop.borderColor,
                backgroundColor: chartConfig.cop.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y1'
            },
            {
                label: 'Ute',
                data: [],
                borderColor: chartConfig.outdoor.borderColor,
                backgroundColor: chartConfig.outdoor.backgroundColor,
                borderWidth: 2,
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                yAxisID: 'y2'
            }
        ],
        [
            { id: 'y1', position: 'left', unit: '', label: 'COP' },
            { id: 'y2', position: 'right', unit: '¬∞C', label: 'Utetemperatur (¬∞C)' }
        ]
    );

    // Load data
    loadAllCharts();
}

document.addEventListener('DOMContentLoaded', initCharts);

// Refresh button
function refreshData() {
    loadAllCharts();
}
</script>
{% endblock %}
