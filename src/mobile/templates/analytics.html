{% extends "base.html" %}
{% set active_page = 'analytics' %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-white">ðŸ“Š Analys & Prestanda</h2>
        <select class="form-select w-auto bg-dark text-white border-secondary shadow-none" id="time-range" onchange="loadCharts()">
            <option value="24">24h</option>
            <option value="48">48h</option>
            <option value="72">3 dygn</option>
            <option value="168">1 vecka</option>
        </select>
    </div>

    <!-- Savings Report (QM Highlight) -->
    <div class="card bg-dark text-white mb-4 border-success shadow">
        <div class="card-header border-success d-flex justify-content-between align-items-center">
            <span class="text-success fw-bold"><i class="bi bi-piggy-bank"></i> Besparingsrapport</span>
            <span class="badge bg-success">AI Evaluator 2.0</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" style="font-size: 0.85rem;">
                    <thead>
                        <tr class="text-muted">
                            <th>Datum</th>
                            <th>Inne (Snitt)</th>
                            <th>Verklig kWh</th>
                            <th>Baseline kWh</th>
                            <th>Besparing (SEK)</th>
                        </tr>
                    </thead>
                    <tbody id="savings-table-body">
                        <tr><td colspan="5" class="text-center py-3">Laddar historik...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Main Chart -->
    <div class="card bg-dark text-white mb-4 border-secondary shadow-sm">
        <div class="card-header border-secondary">
            Temperaturtrender
        </div>
        <div class="card-body">
            <div style="height: 300px;">
                <canvas id="tempChart"></canvas>
            </div>
        </div>
    </div>

    <!-- COP & Compressor -->
    <div class="row g-3">
        <div class="col-md-6">
            <div class="card bg-dark text-white mb-4 border-secondary shadow-sm">
                <div class="card-header border-secondary">
                    Kompressoraktivitet (Hz)
                </div>
                <div class="card-body">
                    <div style="height: 200px;">
                        <canvas id="compChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-dark text-white mb-4 border-secondary shadow-sm">
                <div class="card-header border-secondary">
                    Effektivitet (COP)
                </div>
                <div class="card-body">
                    <div style="height: 200px;">
                        <canvas id="copChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let charts = {};

    async function loadCharts() {
        // Analytics data (existing)
        try {
            const hours = document.getElementById('time-range').value;
            const res = await fetch(`/api/analytics/data?hours=${hours}`);
            const data = await res.json();

            console.log("Analytics Data:", data);

            renderTimeSeriesChart('tempChart', [
                { label: 'Inne', data: data.indoor, borderColor: '#3b82f6', tension: 0.3 },
                { label: 'Ute', data: data.outdoor, borderColor: '#10b981', tension: 0.3 },
                { label: 'Framledning', data: data.supply, borderColor: '#ef4444', tension: 0.3, borderDash: [5,5] }
            ]);

            renderTimeSeriesChart('compChart', [
                { label: 'Hz', data: data.gm, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.2 }
            ]);

            // Note: COP is not in standard analytics/data yet, skipping for now or adding later
        } catch (e) {
            console.error("Chart load error:", e);
        }
    }

    async function loadPerformance() {
        try {
            const res = await fetch('/api/performance');
            const data = await res.json();
            const tbody = document.getElementById('savings-table-body');
            tbody.innerHTML = '';
            
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted">Ingen data tillgÃ¤nglig Ã¤n. KÃ¶rs kl 05:30.</td></tr>';
                return;
            }

            data.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-light">${p.date}</td>
                    <td>${p.avg_indoor.toFixed(1)}Â°C</td>
                    <td>${p.actual_kwh.toFixed(1)}</td>
                    <td>${p.baseline_kwh.toFixed(1)}</td>
                    <td class="text-success fw-bold">+${p.savings_sek.toFixed(2)} kr (${p.savings_percent}%)</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error("Performance load error:", e);
        }
    }

    function renderTimeSeriesChart(canvasId, datasets) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { 
                datasets: datasets.map(ds => ({
                    ...ds,
                    pointRadius: 0,
                    borderWidth: 2
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: true, labels: { color: '#ccc', boxWidth: 10 } } },
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'hour' },
                        ticks: { color: '#6b7280', maxTicksLimit: 6 },
                        grid: { display: false }
                    },
                    y: { 
                        ticks: { color: '#6b7280' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    }
                }
            }
        });
    }

    // Initial load
    loadCharts();
    loadPerformance();
</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}