<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nibe Autotuner V5 - Energy Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .card-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 600; }
        .value-huge { font-size: 2.5rem; font-weight: 700; letter-spacing: -0.03em; line-height: 1; }
        .value-sub { font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem; }
        
        /* Heating Pulse Animation */
        @keyframes heatPulse { 0% { opacity: 0.3; } 50% { opacity: 0.6; } 100% { opacity: 0.3; } }
        .heating-active { animation: heatPulse 3s infinite ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen">

    <!-- TOP ROW: The Result (Temperatures) -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <!-- Zone 1: Downstairs (Slab) -->
        <div class="glass p-5 rounded-3xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üè°</div>
            <div class="card-label mb-2">Zon 1: Nere (Betongplatta)</div>
            <div class="value-huge text-blue-400" id="temp-down">--¬∞C</div>
            <div class="value-sub flex items-center gap-2">
                <span>M√•l: 21.0¬∞C</span>
                <span class="text-xs px-2 py-0.5 rounded-full bg-white/5" id="hum-down">--% RH</span>
            </div>
        </div>

        <!-- Zone 2: Dexter (Radiators) -->
        <div class="glass p-5 rounded-3xl relative overflow-hidden border-l-2 border-purple-500/50">
            <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üõå</div>
            <div class="card-label mb-2">Zon 2: Dexter (Radiatorer)</div>
            <div class="value-huge text-purple-400" id="temp-dexter">--¬∞C</div>
            <div class="value-sub text-purple-300/60" id="dexter-status">V√§ntar p√• v√§rme...</div>
        </div>
    </div>

    <!-- MIDDLE ROW: The Machine & Cost -->
    <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="glass p-4 rounded-2xl">
            <div class="card-label">Utomhus</div>
            <div class="text-xl font-bold mt-1" id="temp-out">--¬∞C</div>
            <div class="text-xs text-slate-500 mt-1 flex items-center gap-1">
                <span id="wind-icon" class="inline-block transition-transform duration-700">‚¨á</span>
                <span id="wind-speed">-- m/s</span>
            </div>
        </div>
        <div class="glass p-4 rounded-2xl">
            <div class="card-label">Framledning</div>
            <div class="text-xl font-bold text-orange-400 mt-1" id="supply-temp">--¬∞C</div>
            <div class="text-xs text-slate-500 mt-1" id="comp-hz">-- Hz</div>
        </div>
        <div class="glass p-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900">
            <div class="card-label">Elpris Nu</div>
            <div class="text-xl font-bold text-yellow-400 mt-1" id="price-now">-- √∂re</div>
            <div class="text-xs text-yellow-500/50 mt-1">Spotpris</div>
        </div>
    </div>

    <!-- VISUALIZATION: The Energy Narrative -->
    <div class="glass p-6 rounded-3xl mb-8">
        <div class="flex justify-between items-end mb-4">
            <div>
                <h2 class="text-lg font-bold text-white">Energi-Puls & Termisk Respons</h2>
                <p class="text-xs text-slate-400 mt-1">Visar hur systemet laddar huset (Block) baserat p√• elpris (Botten) och hur v√§rmen stiger (Linjer).</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-[10px] font-mono">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-blue-500/30 rounded-sm"></div> <span class="text-slate-400">Grundv√§rme (Zon 1)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-orange-500/40 rounded-sm"></div> <span class="text-slate-400">Spetsv√§rme (Zon 2)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-1 bg-blue-400"></div> <span class="text-slate-400">Temp Nere (Tr√∂g)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-green-500/20 border border-green-500/30 rounded-sm"></div> <span class="text-slate-400">Billig El</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-slate-500/20 border border-slate-500/30 rounded-sm"></div> <span class="text-slate-400">Utetemp (Yta)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 bg-red-500/20 border border-red-500/30 rounded-sm"></div> <span class="text-slate-400">Dyr El</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-0.5 border-t border-dashed border-purple-400"></div> <span class="text-slate-400">Temp Dexter</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-0.5 bg-orange-500"></div> <span class="text-orange-200 font-bold">Fram (Rad)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-0.5 border-t border-dashed border-cyan-400"></div> <span class="text-cyan-200">Fram (Golv)</span></div>
            </div>
        </div>
        
        <div class="h-80 w-full relative">
            <canvas id="energyChart"></canvas>
        </div>
    </div>

    <!-- THE SCIENTIST: AI Calibration -->
    <div class="glass p-6 rounded-3xl mb-8">
        <h3 class="card-label mb-4 text-slate-400">The Scientist - Inl√§rning & Kalibrering</h3>
        
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Left Column: Global & Zone 1 -->
            <div>
                <h4 class="text-[10px] font-bold text-cyan-400 mb-3 uppercase tracking-wider border-b border-cyan-500/20 pb-1">Globalt & Zon 1 (Nere)</h4>
                <div class="grid grid-cols-2 gap-3" id="tuning-zone1"></div>
            </div>

            <!-- Right Column: Zone 2 -->
            <div>
                <h4 class="text-[10px] font-bold text-purple-400 mb-3 uppercase tracking-wider border-b border-purple-500/20 pb-1">Zon 2 (Dexter)</h4>
                <div class="grid grid-cols-2 gap-3" id="tuning-zone2"></div>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t border-white/5 text-[10px] text-slate-500 italic">
            AI analysera husets respons varje natt kl 03:00 och justerar fysikmodellen.
        </div>
    </div>

    <!-- LOGIC EXPLAINER -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-slate-500">
        <div class="glass p-4 rounded-xl">
            <strong class="text-slate-300 block mb-1">First Principle: Termisk Tr√∂ghet</strong>
            Systemet "laddar" betongplattan (Zon 1) n√§r elpriset √§r l√•gt (Gr√∂na f√§lt). V√§rmen lagras och avges l√•ngsamt √∂ver dygnet.
        </div>
        <div class="glass p-4 rounded-xl">
            <strong class="text-slate-300 block mb-1">First Principle: Direktverkan</strong>
            Zon 2 (Dexter) har l√•g tr√∂ghet. H√§r kr√§vs "Spetsv√§rme" (Orange block) med h√∂gre framledningstemp exakt n√§r behovet finns, oavsett tr√∂ghet.
        </div>
    </div>

    <script>
        // --- DATA FETCHING & RENDERING ---
        
        async function loadData() {
            const res = await fetch('/api/v4/dashboard');
            const data = await res.json();
            updateMetrics(data.status);
            updateTuning(data.tuning);
            renderEnergyChart(data.plan);
        }

        function updateTuning(tuning) {
            const div1 = document.getElementById('tuning-zone1');
            const div2 = document.getElementById('tuning-zone2');
            div1.innerHTML = '';
            div2.innerHTML = '';

            const params1 = [
                {k: 'price_wind_sensitivity', l: 'Vind-K√§nslighet (Pris)'},
                {k: 'price_temp_sensitivity', l: 'Temp-K√§nslighet (Pris)'},
                {k: 'weekend_discount_factor', l: 'Helg-Rabatt'},
                {k: 'thermal_leakage', l: 'V√§rmel√§ckage'},
                {k: 'wind_sensitivity', l: 'Vindk√§nslighet'}
            ];

            const params2 = [
                {k: 'thermal_leakage_dexter', l: 'V√§rmel√§ckage'},
                {k: 'wind_sensitivity_dexter', l: 'Vindk√§nslighet'},
                {k: 'wind_direction_west_factor', l: 'V√§stvind-Faktor'},
                {k: 'rad_efficiency', l: 'Radiator-Effekt'}
            ];
            
            const renderParam = (div, p) => {
                if(tuning[p.k]) {
                    div.innerHTML += `
                        <div class="bg-white/5 p-2.5 rounded-xl">
                            <div class="text-[9px] text-slate-500 uppercase tracking-wider mb-0.5">${p.l}</div>
                            <div class="text-base font-bold text-slate-200">${tuning[p.k].toFixed(3)}</div>
                        </div>
                    `;
                }
            };

            params1.forEach(p => renderParam(div1, p));
            params2.forEach(p => renderParam(div2, p));
        }

        function updateMetrics(s) {
            document.getElementById('temp-down').innerText = s.indoor_downstairs.toFixed(1) + '¬∞C';
            document.getElementById('temp-dexter').innerText = s.indoor_dexter.toFixed(1) + '¬∞C';
            document.getElementById('temp-out').innerText = s.outdoor_temp.toFixed(1) + '¬∞C';
            document.getElementById('hum-down').innerText = (s.indoor_humidity || '--') + '% RH';
            document.getElementById('supply-temp').innerText = (s.supply_temp || '--') + '¬∞C';
            document.getElementById('comp-hz').innerText = s.compressor_freq.toFixed(0) + ' Hz';
            document.getElementById('price-now').innerText = (s.current_price * 100).toFixed(0) + ' √∂re';
            
            // Wind
            const ws = (s.wind_speed || 0).toFixed(1);
            document.getElementById('wind-speed').innerText = ws + ' m/s';
            if (s.wind_direction !== undefined) {
                // Rotate arrow (0=N, 180=S). Standard arrow '‚¨á' points down (South?). 
                // Let's assume standard up arrow '‚¨Ü' is 0 deg. Wait, I used down arrow.
                // Let's use a standard transform. 
                // Wind direction is "coming FROM". So 0 deg (North Wind) comes from North, blows South.
                // So the arrow should point WITH the wind. 
                // If wind is 0 deg (N), it blows TO South (180).
                // Let's rotate the arrow to point in the direction the wind is blowing TO.
                // Rotation = wind_dir + 180.
                const rotation = (s.wind_direction + 180) % 360;
                document.getElementById('wind-icon').style.transform = `rotate(${rotation}deg)`;
            }
            
            // Dexter Status Logic
            const dStatus = document.getElementById('dexter-status');
            if (s.indoor_dexter < 19.8) {
                dStatus.innerHTML = '<span class="text-orange-400">Beg√§r Spetsv√§rme!</span>';
            } else {
                dStatus.innerHTML = '<span class="text-green-400/60">Temperatur OK</span>';
            }
        }

        let energyChart;

        function renderEnergyChart(plan) {
            if (!plan || plan.length === 0) return;

            const ctx = document.getElementById('energyChart').getContext('2d');
            const labels = plan.map(p => new Date(p.time).getHours() + ':00');

            // 1. Prepare Data Series
            const tempDown = plan.map(p => p.temp_sim_down);
            const tempDexter = plan.map(p => p.temp_sim_dexter);
            const supplyDown = plan.map(p => p.supply_down);
            const supplyDexter = plan.map(p => p.supply_dexter);
            const tempOut = plan.map(p => p.temp_out);
            const prices = plan.map(p => p.price * 100); 
            
            // Calculate Min/Max Price safely
            let maxPrice = 100;
            let minPrice = 0;
            if (prices.length > 0) {
                maxPrice = Math.max(...prices);
                const sorted = [...prices].sort((a, b) => a - b);
                minPrice = sorted[0];
            }
            
            // Calculate Median and Percentiles for better color context
            const sortedPrices = [...prices].sort((a, b) => a - b);
            const lowThreshold = sortedPrices[Math.floor(sortedPrices.length * 0.33)] || 0;
            const highThreshold = sortedPrices[Math.floor(sortedPrices.length * 0.66)] || 100;

            // 2. Construct "Heating Blocks"
            const heatingBlocks = plan.map(p => {
                if (p.action === 'RUN' || p.action === 'MUST_RUN') {
                    if (p.offset > 2) return { y: 100, type: 'BOOST' }; 
                    return { y: 100, type: 'BASE' };
                }
                return { y: 0, type: 'NONE' };
            });

            const baseHeatingData = heatingBlocks.map(b => b.type === 'BASE' ? b.y : 0);
            const boostHeatingData = heatingBlocks.map(b => b.type === 'BOOST' ? b.y : 0);

            // 3. Price Coloring
            const priceColors = prices.map(price => {
                if (price <= lowThreshold) return 'rgba(34, 197, 94, 0.15)'; 
                if (price >= highThreshold) return 'rgba(239, 68, 68, 0.15)'; 
                return 'rgba(234, 179, 8, 0.1)'; 
            });

            if (energyChart) energyChart.destroy();

            energyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        // LAYER 0: Outdoor Temp
                        {
                            label: 'Utetemp',
                            data: tempOut,
                            type: 'line',
                            backgroundColor: 'rgba(71, 85, 105, 0.15)', 
                            borderColor: 'rgba(71, 85, 105, 0.2)',
                            borderWidth: 1,
                            fill: 'start',
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'yOut',
                            order: 10
                        },
                        // LAYER 1: Heating Action
                        {
                            label: 'Drift (Laddning)',
                            data: baseHeatingData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', 
                            barPercentage: 1.0,
                            categoryPercentage: 1.0,
                            yAxisID: 'yActivity',
                            order: 5
                        },
                        {
                            label: 'Drift (Boost)',
                            data: boostHeatingData,
                            backgroundColor: 'rgba(249, 115, 22, 0.8)', 
                            barPercentage: 1.0,
                            categoryPercentage: 1.0,
                            yAxisID: 'yActivity',
                            order: 5
                        },
                        // LAYER 2: Price
                        {
                            label: 'Elpris (√∂re)',
                            data: prices,
                            backgroundColor: priceColors,
                            borderRadius: 0,
                            barPercentage: 1.0, 
                            categoryPercentage: 1.0,
                            yAxisID: 'yPrice',
                            order: 20
                        },
                        // LAYER 3: Indoor Temps
                        {
                            label: 'Temp Nere (Tr√∂g)',
                            data: tempDown,
                            type: 'line',
                            borderColor: '#22d3ee', 
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 0,
                            yAxisID: 'yTemp',
                            order: 1
                        },
                        {
                            label: 'Temp Dexter (Snabb)',
                            data: tempDexter,
                            type: 'line',
                            borderColor: '#c084fc', 
                            borderWidth: 3,
                            borderDash: [5, 5], 
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'yTemp',
                            order: 0
                        },
                        // LAYER 4: Supply Temp (Split)
                        {
                            label: 'Framledning (Rad)',
                            data: supplyDexter,
                            type: 'line',
                            borderColor: '#f97316', 
                            borderWidth: 1.5,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'ySupply',
                            order: 0
                        },
                        {
                            label: 'Framledning (Golv)',
                            data: supplyDown,
                            type: 'line',
                            borderColor: '#22d3ee', 
                            borderWidth: 1.5,
                            borderDash: [2, 2],
                            fill: false,
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'ySupply',
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#64748b' } },
                        yTemp: {
                            type: 'linear',
                            position: 'left',
                            min: 19,
                            max: 23,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#e2e8f0', callback: v => v + '¬∞' }
                        },
                        ySupply: {
                            type: 'linear',
                            position: 'right',
                            min: 20,
                            max: 60,
                            grid: { display: false },
                            ticks: { display: false } 
                        },
                        yOut: {
                            type: 'linear',
                            position: 'left',
                            display: false,
                            min: -15,
                            max: 35 
                        },
                        yActivity: {
                            display: false, 
                            min: 0,
                            max: 2000
                        },
                        yPrice: {
                            type: 'linear',
                            position: 'right',
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#ca8a04', 
                                callback: v => v + ' √∂' 
                            },
                            min: minPrice * 0.9,
                            max: maxPrice * 1.1 
                        }
                    }
                }
            });
        }

        loadData();
        setInterval(loadData, 60000); // Refresh every minute
    </script>
</body>
</html>
