{% extends "base.html" %}

{% block title %}Dashboard - Nibe Autotuner{% endblock %}

{% block content %}
<!-- Loading indicator -->
<div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Laddar data...</p>
</div>

<!-- Error message -->
<div id="error" class="error" style="display: none;"></div>

<!-- Last updated -->
<div class="last-updated">
    <small>Uppdaterad: <span id="lastUpdate">-</span></small>
</div>

<!-- Optimization Score Banner -->
<section class="optimization-banner" id="optimizationBanner" style="display: none;">
    <div class="opt-score-container">
        <div class="opt-score-circle" id="optScoreCircle">
            <div class="opt-score-value" id="optScoreValue">-</div>
            <div class="opt-score-label">Po√§ng</div>
        </div>
        <div class="opt-score-details">
            <div class="opt-score-badge" id="optScoreBadge">-</div>
            <div class="opt-score-subtitle">Systemets √∂vergripande prestanda</div>
        </div>
    </div>
</section>

<!-- Cost Analysis -->
<section class="section" id="costSection" style="display: none;">
    <h2 class="section-title">üí∞ Kostnadsanalys</h2>
    <div class="cost-grid">
        <div class="cost-card">
            <div class="cost-label">Per dag</div>
            <div class="cost-value" id="dailyCost">-</div>
        </div>
        <div class="cost-card">
            <div class="cost-label">Per m√•nad</div>
            <div class="cost-value" id="monthlyCost">-</div>
        </div>
        <div class="cost-card total">
            <div class="cost-label">Per √•r</div>
            <div class="cost-value" id="yearlyCost">-</div>
        </div>
    </div>
    <div class="savings-info" id="savingsInfo" style="margin-top: 1rem; padding: 1rem; background: var(--success-bg); border-radius: 8px; display: none;">
        <p style="margin: 0; color: var(--success-color); font-weight: 500;">
            üí∞ Du sparar <strong id="savingsAmount">-</strong> per √•r j√§mf√∂rt med osoptimerat system (COP 2.5)!
        </p>
    </div>
</section>

<!-- AI Optimization Suggestions -->
<section class="section" id="suggestionsSection" style="display: none;">
    <h2 class="section-title">ü§ñ AI-rekommendationer</h2>
    <div id="suggestionsList"></div>
</section>

<!-- Quick Actions -->
<section class="section">
    <h2 class="section-title">‚ö° Snabb√•tg√§rder</h2>
    <div class="quick-actions-grid">
        <button class="quick-action-btn cold" onclick="adjustTemperature(1)">
            <div class="qa-icon">ü•∂</div>
            <div class="qa-label">Kallt inne</div>
            <div class="qa-detail">H√∂j offset +1</div>
        </button>
        <button class="quick-action-btn hot" onclick="adjustTemperature(-1)">
            <div class="qa-icon">ü•µ</div>
            <div class="qa-label">Varmt inne</div>
            <div class="qa-detail">S√§nk offset -1</div>
        </button>
        <button class="quick-action-btn efficiency" onclick="optimizeForEfficiency()">
            <div class="qa-icon">‚ö°</div>
            <div class="qa-label">Max COP</div>
            <div class="qa-detail">Optimera effektivitet</div>
        </button>
        <button class="quick-action-btn comfort" onclick="optimizeForComfort()">
            <div class="qa-icon">üè†</div>
            <div class="qa-label">Max komfort</div>
            <div class="qa-detail">Stabil temp 21¬∞C</div>
        </button>
    </div>
</section>

<!-- Main metrics -->
<section class="metrics-grid">
    <div class="metric-card highlight">
        <div class="metric-icon">‚ö°</div>
        <div class="metric-value" id="cop">-</div>
        <div class="metric-label">COP</div>
        <div class="metric-status" id="copStatus"></div>
    </div>

    <div class="metric-card">
        <div class="metric-icon">üìê</div>
        <div class="metric-value" id="degreeMinutes">-</div>
        <div class="metric-label">Gradminuter</div>
        <div class="metric-status" id="dmStatus"></div>
    </div>

    <div class="metric-card highlight">
        <div class="metric-icon">üå°Ô∏è</div>
        <div class="metric-value" id="deltaT">-</div>
        <div class="metric-label">Delta T (Aktiv)</div>
        <div class="metric-status" id="dtStatus"></div>
    </div>

    <div class="metric-card">
        <div class="metric-icon">‚öôÔ∏è</div>
        <div class="metric-value" id="compressor">-</div>
        <div class="metric-label">Kompressor Hz</div>
    </div>
</section>

<!-- Temperatures -->
<section class="section">
    <h2 class="section-title">üå°Ô∏è Temperaturer</h2>
    <div class="temp-grid">
        <div class="temp-item">
            <span class="temp-label">Ute</span>
            <span class="temp-value" id="outdoorTemp">-</span>
        </div>
        <div class="temp-item">
            <span class="temp-label">Inne</span>
            <span class="temp-value" id="indoorTemp">-</span>
        </div>
        <div class="temp-item">
            <span class="temp-label">Fram</span>
            <span class="temp-value" id="supplyTemp">-</span>
        </div>
        <div class="temp-item">
            <span class="temp-label">Retur</span>
            <span class="temp-value" id="returnTemp">-</span>
        </div>
    </div>
</section>

<!-- Ventilation Status -->
<section class="section" id="ventilationSection" style="display: none;">
    <h2 class="section-title">üí® Ventilation</h2>
    <div class="card">
        <div class="card-header">
            <div class="strategy-badge" id="ventStrategyBadge">-</div>
            <span class="ventilation-status" id="ventStatus"></span>
        </div>
        <div class="card-body">
            <div class="vent-metrics-grid">
                <div class="vent-metric">
                    <div class="vent-metric-label">Fr√•nluftstemp</div>
                    <div class="vent-metric-value" id="exhaustTemp">-</div>
                </div>
                <div class="vent-metric">
                    <div class="vent-metric-label">Fl√§kthastighet</div>
                    <div class="vent-metric-value" id="fanSpeed">-</div>
                </div>
                <div class="vent-metric">
                    <div class="vent-metric-label">Temp-lyft</div>
                    <div class="vent-metric-value" id="tempLift">-</div>
                </div>
                <div class="vent-metric">
                    <div class="vent-metric-label">RF-drop (est)</div>
                    <div class="vent-metric-value" id="rhDrop">-</div>
                </div>
            </div>
            <div class="ventilation-reasoning" id="ventReasoning" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #666;">
                <!-- Reasoning will be inserted here -->
            </div>
        </div>
    </div>
</section>

<style>
.strategy-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
}

.strategy-badge.warm {
    background: #ff9800;
    color: white;
}

.strategy-badge.mild {
    background: #4CAF50;
    color: white;
}

.strategy-badge.cold {
    background: #2196F3;
    color: white;
}

.strategy-badge.extreme_cold {
    background: #9C27B0;
    color: white;
}

.ventilation-status {
    font-size: 0.85rem;
    color: #666;
}

.vent-metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.vent-metric {
    text-align: center;
}

.vent-metric-label {
    font-size: 0.75rem;
    color: #666;
    margin-bottom: 0.25rem;
}

.vent-metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
}
</style>

<!-- Delta T Breakdown -->
<section class="section">
    <h2 class="section-title">üìä Delta T Analys</h2>
    <div class="delta-grid">
        <div class="delta-item">
            <div class="delta-label">Uppv√§rmning (Aktiv)</div>
            <div class="delta-value" id="deltaTActive">-</div>
            <div class="delta-status" id="deltaTActiveStatus"></div>
        </div>
        <div class="delta-item">
            <div class="delta-label">Varmvatten</div>
            <div class="delta-value" id="deltaTHotWater">-</div>
        </div>
    </div>
</section>

<!-- Separate Metrics: Heating vs Hot Water -->
<section class="section">
    <h2 class="section-title">üî• Uppv√§rmning vs üíß Varmvatten</h2>

    <div class="comparison-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
        <!-- Heating Column -->
        <div class="comparison-column">
            <h3 style="color: var(--primary-color); text-align: center; margin-bottom: 0.5rem;">üî• Uppv√§rmning</h3>
            <div class="metric-card" id="heatingCard">
                <div class="metric-row">
                    <span class="metric-small-label">COP:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="heatingCOP">-</span>
                        <span class="performance-badge" id="heatingCOPBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Delta T:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="heatingDeltaT">-</span>
                        <span class="performance-badge" id="heatingDeltaTBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Runtime:</span>
                    <span class="metric-small-value" id="heatingRuntime">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Cykler:</span>
                    <span class="metric-small-value" id="heatingCycles">-</span>
                </div>
            </div>
        </div>

        <!-- Hot Water Column -->
        <div class="comparison-column">
            <h3 style="color: #ff5722; text-align: center; margin-bottom: 0.5rem;">üíß Varmvatten</h3>
            <div class="metric-card" id="hotWaterCard">
                <div class="metric-row">
                    <span class="metric-small-label">COP:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="hotWaterCOP">-</span>
                        <span class="performance-badge" id="hotWaterCOPBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Delta T:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="hotWaterDeltaT">-</span>
                        <span class="performance-badge" id="hotWaterDeltaTBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">VV Temp:</span>
                    <span class="metric-small-value" id="hotWaterTemp">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Runtime:</span>
                    <span class="metric-small-value" id="hotWaterRuntime">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Cykler:</span>
                    <span class="metric-small-value" id="hotWaterCycles">-</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- System Settings -->
<section class="section">
    <h2 class="section-title">‚öôÔ∏è Systeminst√§llningar</h2>
    <div class="settings-grid">
        <div class="setting-item">
            <span class="setting-label">V√§rmekurva</span>
            <span class="setting-value" id="heatingCurve">-</span>
        </div>
        <div class="setting-item">
            <span class="setting-label">Kurvjustering</span>
            <span class="setting-value" id="curveOffset">-</span>
        </div>
    </div>
</section>

<!-- Time period selector -->
<section class="section">
    <label for="timePeriod" class="form-label">Analysperiod:</label>
    <select id="timePeriod" class="form-select" onchange="loadDashboard()">
        <option value="1">Senaste timmen</option>
        <option value="6">Senaste 6 timmarna</option>
        <option value="24">Senaste 24 timmarna</option>
        <option value="72" selected>Senaste 3 dagarna</option>
        <option value="168">Senaste veckan</option>
    </select>
</section>

{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval = null;

async function loadDashboard() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const hours = document.getElementById('timePeriod').value;

    loading.style.display = 'block';
    error.style.display = 'none';

    try {
        // Load all data in parallel
        const [metricsRes, scoreRes, costRes, suggestionsRes, ventRes] = await Promise.all([
            fetch(`/api/metrics?hours=${hours}`),
            fetch(`/api/performance-score?hours=${hours}`),
            fetch(`/api/cost-analysis?hours=${hours}`),
            fetch(`/api/optimization-suggestions?hours=${hours}`),
            fetch(`/api/ventilation/status`)
        ]);

        const metricsResult = await metricsRes.json();
        const scoreResult = await scoreRes.json();
        const costResult = await costRes.json();
        const suggestionsResult = await suggestionsRes.json();
        const ventResult = await ventRes.json();

        if (!metricsResult.success) {
            throw new Error(metricsResult.error);
        }

        const data = metricsResult.data;

        // Update Performance Score
        if (scoreResult.success) {
            updatePerformanceScore(scoreResult.data);
        }

        // Update Cost Analysis
        if (costResult.success) {
            updateCostAnalysis(costResult.data);
        }

        // Update Optimization Suggestions (will add this section)
        if (suggestionsResult.success && suggestionsResult.data.length > 0) {
            updateSuggestions(suggestionsResult.data);
        }

        // Update Ventilation Status
        if (ventResult.success) {
            updateVentilation(ventResult.data);
        }

        // Update main metrics
        document.getElementById('cop').textContent = data.cop ? data.cop.toFixed(2) : 'N/A';
        document.getElementById('copStatus').textContent = data.cop && data.cop >= 3.0 ? '‚úÖ Utm√§rkt' : '‚ö†Ô∏è';

        document.getElementById('degreeMinutes').textContent = data.degree_minutes.toFixed(0);
        const dmOk = data.degree_minutes >= -300 && data.degree_minutes <= -100;
        document.getElementById('dmStatus').textContent = dmOk ? '‚úÖ' : '‚ö†Ô∏è';

        if (data.delta_t_active) {
            document.getElementById('deltaT').textContent = data.delta_t_active.toFixed(1) + '¬∞C';
            const dtOk = data.delta_t_active >= 3 && data.delta_t_active <= 8;
            document.getElementById('dtStatus').textContent = dtOk ? '‚úÖ Optimalt' : '‚ö†Ô∏è Justera';
        } else {
            document.getElementById('deltaT').textContent = 'N/A';
            document.getElementById('dtStatus').textContent = '';
        }

        document.getElementById('compressor').textContent = data.avg_compressor_freq.toFixed(0) + ' Hz';

        // Update temperatures
        document.getElementById('outdoorTemp').textContent = data.avg_outdoor_temp.toFixed(1) + '¬∞C';
        document.getElementById('indoorTemp').textContent = data.avg_indoor_temp.toFixed(1) + '¬∞C';
        document.getElementById('supplyTemp').textContent = data.avg_supply_temp.toFixed(1) + '¬∞C';
        document.getElementById('returnTemp').textContent = data.avg_return_temp.toFixed(1) + '¬∞C';

        // Update Delta T breakdown
        if (data.delta_t_active) {
            document.getElementById('deltaTActive').textContent = data.delta_t_active.toFixed(1) + '¬∞C';
            const dtOk = data.delta_t_active >= 3 && data.delta_t_active <= 8;
            document.getElementById('deltaTActiveStatus').textContent = dtOk ? '‚úÖ 3-8¬∞C optimal' : '‚ö†Ô∏è B√∂r vara 3-8¬∞C';
        } else {
            document.getElementById('deltaTActive').textContent = 'N/A';
            document.getElementById('deltaTActiveStatus').textContent = 'Ingen aktiv uppv√§rmning';
        }

        if (data.delta_t_hot_water) {
            document.getElementById('deltaTHotWater').textContent = data.delta_t_hot_water.toFixed(1) + '¬∞C';
        } else {
            document.getElementById('deltaTHotWater').textContent = 'N/A';
        }

        // Update settings
        document.getElementById('heatingCurve').textContent = data.heating_curve.toFixed(1);
        document.getElementById('curveOffset').textContent = data.curve_offset.toFixed(1);

        // Update separate heating metrics
        const heatingCard = document.getElementById('heatingCard');
        if (data.heating) {
            heatingCard.style.display = 'block';
            document.getElementById('heatingCOP').textContent = data.heating.cop ? data.heating.cop.toFixed(2) : 'N/A';
            document.getElementById('heatingDeltaT').textContent = data.heating.delta_t ? data.heating.delta_t.toFixed(1) + '¬∞C' : 'N/A';
            document.getElementById('heatingRuntime').textContent = data.heating.runtime_hours ? data.heating.runtime_hours.toFixed(1) + 'h' : 'N/A';
            document.getElementById('heatingCycles').textContent = data.heating.num_cycles || '0';

            // Set COP badge
            const copBadge = document.getElementById('heatingCOPBadge');
            if (data.heating.cop_rating) {
                copBadge.textContent = data.heating.cop_rating.badge;
                copBadge.style.backgroundColor = data.heating.cop_rating.color;
                copBadge.style.display = 'inline-block';
            }

            // Set Delta T badge
            const deltaTBadge = document.getElementById('heatingDeltaTBadge');
            if (data.heating.delta_t_rating) {
                deltaTBadge.textContent = data.heating.delta_t_rating.badge;
                deltaTBadge.style.backgroundColor = data.heating.delta_t_rating.color;
                deltaTBadge.style.display = 'inline-block';
            }
        } else {
            heatingCard.style.display = 'none';
        }

        // Update separate hot water metrics
        const hotWaterCard = document.getElementById('hotWaterCard');
        if (data.hot_water) {
            hotWaterCard.style.display = 'block';
            document.getElementById('hotWaterCOP').textContent = data.hot_water.cop ? data.hot_water.cop.toFixed(2) : 'N/A';
            document.getElementById('hotWaterDeltaT').textContent = data.hot_water.delta_t ? data.hot_water.delta_t.toFixed(1) + '¬∞C' : 'N/A';
            document.getElementById('hotWaterTemp').textContent = data.hot_water.avg_hot_water_temp ? data.hot_water.avg_hot_water_temp.toFixed(1) + '¬∞C' : 'N/A';
            document.getElementById('hotWaterRuntime').textContent = data.hot_water.runtime_hours ? data.hot_water.runtime_hours.toFixed(1) + 'h' : 'N/A';
            document.getElementById('hotWaterCycles').textContent = data.hot_water.num_cycles || '0';

            // Set COP badge
            const copBadge = document.getElementById('hotWaterCOPBadge');
            if (data.hot_water.cop_rating) {
                copBadge.textContent = data.hot_water.cop_rating.badge;
                copBadge.style.backgroundColor = data.hot_water.cop_rating.color;
                copBadge.style.display = 'inline-block';
            }

            // Set Delta T badge
            const deltaTBadge = document.getElementById('hotWaterDeltaTBadge');
            if (data.hot_water.delta_t_rating) {
                deltaTBadge.textContent = data.hot_water.delta_t_rating.badge;
                deltaTBadge.style.backgroundColor = data.hot_water.delta_t_rating.color;
                deltaTBadge.style.display = 'inline-block';
            }
        } else {
            hotWaterCard.style.display = 'none';
        }

        // Update timestamp
        const timestamp = new Date(data.timestamp);
        document.getElementById('lastUpdate').textContent = timestamp.toLocaleTimeString('sv-SE');

    } catch (err) {
        error.textContent = '‚ùå Fel vid laddning av data: ' + err.message;
        error.style.display = 'block';
        console.error('Error loading dashboard:', err);
    } finally {
        loading.style.display = 'none';
    }
}

function updatePerformanceScore(data) {
    const banner = document.getElementById('optimizationBanner');
    const circle = document.getElementById('optScoreCircle');
    const value = document.getElementById('optScoreValue');
    const badge = document.getElementById('optScoreBadge');

    value.textContent = data.total_score;
    badge.textContent = `${data.grade} ${data.emoji}`;

    // Color based on grade
    const gradeColors = {
        'A+': '#4caf50',
        'A': '#66bb6a',
        'B': '#9ccc65',
        'C': '#ffeb3b',
        'D': '#ff9800',
        'F': '#f44336'
    };
    const color = gradeColors[data.grade] || '#9e9e9e';
    circle.style.background = `conic-gradient(${color} ${data.total_score * 3.6}deg, #e0e0e0 0deg)`;

    banner.style.display = 'block';
}

function updateCostAnalysis(data) {
    const section = document.getElementById('costSection');

    document.getElementById('dailyCost').textContent = `${data.daily_cost_sek.toFixed(0)} kr`;
    document.getElementById('monthlyCost').textContent = `${data.monthly_cost_sek.toFixed(0)} kr`;
    document.getElementById('yearlyCost').textContent = `${data.yearly_cost_sek.toFixed(0)} kr`;

    // Show savings if applicable
    if (data.savings_yearly > 0) {
        document.getElementById('savingsAmount').textContent = `${data.savings_yearly.toFixed(0)} kr`;
        document.getElementById('savingsInfo').style.display = 'block';
    } else {
        document.getElementById('savingsInfo').style.display = 'none';
    }

    section.style.display = 'block';
}

function updateSuggestions(suggestions) {
    const section = document.getElementById('suggestionsSection');
    const list = document.getElementById('suggestionsList');

    if (!suggestions || suggestions.length === 0) {
        section.style.display = 'none';
        return;
    }

    const priorityColors = {
        'high': '#f44336',
        'medium': '#ff9800',
        'low': '#4caf50'
    };

    const priorityLabels = {
        'high': 'H√ñG',
        'medium': 'MEDEL',
        'low': 'L√ÖG'
    };

    list.innerHTML = suggestions.map(s => `
        <div class="suggestion-card" style="margin-bottom: 1rem; padding: 1rem; border-left: 4px solid ${priorityColors[s.priority]}; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <h3 style="margin: 0; font-size: 1rem; color: var(--text-primary);">${s.title}</h3>
                <span style="padding: 0.25rem 0.5rem; background: ${priorityColors[s.priority]}; color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                    ${priorityLabels[s.priority]}
                </span>
            </div>
            <p style="margin: 0.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">${s.description}</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e0e0e0;">
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">F√∂rv√§ntad COP-f√∂rb√§ttring</div>
                    <div style="font-weight: 600; color: var(--primary-color);">+${s.expected_cop_improvement.toFixed(2)}</div>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Besparing/√•r</div>
                    <div style="font-weight: 600; color: var(--success-color);">${s.expected_savings_yearly.toFixed(0)} kr</div>
                </div>
            </div>
            <div style="margin-top: 0.75rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.25rem;">üí° F√∂rklaring:</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">${s.reasoning}</div>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                Confidence: ${(s.confidence * 100).toFixed(0)}%
            </div>
        </div>
    `).join('');

    section.style.display = 'block';
}

function updateVentilation(data) {
    const section = document.getElementById('ventilationSection');

    if (!data) {
        section.style.display = 'none';
        return;
    }

    // Show section
    section.style.display = 'block';

    // Update strategy badge
    const strategyBadge = document.getElementById('ventStrategyBadge');
    strategyBadge.textContent = data.current_strategy;
    strategyBadge.className = 'strategy-badge ' + data.current_strategy.toLowerCase();

    // Update status
    const status = document.getElementById('ventStatus');
    status.textContent = data.needs_adjustment ? '‚ö†Ô∏è Justering rekommenderas' : '‚úÖ Optimalt';

    // Update metrics
    document.getElementById('exhaustTemp').textContent = data.exhaust_temp ? data.exhaust_temp.toFixed(1) + '¬∞C' : 'N/A';
    document.getElementById('fanSpeed').textContent = data.fan_speed_pct ? data.fan_speed_pct + '%' : 'N/A';
    document.getElementById('tempLift').textContent = data.temp_lift ? data.temp_lift.toFixed(1) + '¬∞C' : 'N/A';
    document.getElementById('rhDrop').textContent = data.estimated_rh_drop_pct ? data.estimated_rh_drop_pct.toFixed(0) + '%' : 'N/A';

    // Update reasoning
    const reasoning = document.getElementById('ventReasoning');
    reasoning.innerHTML = `<strong>Strategi:</strong> ${data.reasoning}`;
}

function refreshData() {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('spinning');

    loadDashboard().finally(() => {
        setTimeout(() => icon.classList.remove('spinning'), 500);
    });
}

// Auto-refresh every 5 minutes
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    autoRefreshInterval = setInterval(loadDashboard, 5 * 60 * 1000);
}

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
    startAutoRefresh();
});

// Refresh when page becomes visible
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        loadDashboard();
    }
});

// Quick Actions
async function adjustTemperature(delta) {
    if (!confirm(`Vill du ${delta > 0 ? 'h√∂ja' : 's√§nka'} kurvjusteringen med ${Math.abs(delta)}?`)) {
        return;
    }

    try {
        const response = await fetch('/api/quick-action/adjust-offset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({delta: delta})
        });
        const result = await response.json();

        if (result.success) {
            alert(`‚úÖ ${result.message}\nNy kurvjustering: ${result.new_value}`);
            loadDashboard();
        } else {
            alert(`‚ùå Fel: ${result.error}`);
        }
    } catch (err) {
        alert(`‚ùå Fel: ${err.message}`);
    }
}

async function optimizeForEfficiency() {
    if (!confirm('Optimera f√∂r maximal COP?\n\nDetta kan s√§nka v√§rmekurvan n√•got f√∂r b√§ttre effektivitet.')) {
        return;
    }

    try {
        const response = await fetch('/api/quick-action/optimize-efficiency', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();

        if (result.success) {
            let msg = `‚úÖ ${result.message}`;
            if (result.changes && result.changes.length > 0) {
                msg += '\n\n√Ñndringar:';
                result.changes.forEach(c => {
                    msg += `\n‚Ä¢ ${c.parameter}: ${c.old_value} ‚Üí ${c.new_value}`;
                });
            }
            alert(msg);
            loadDashboard();
        } else {
            alert(`‚ùå ${result.error}`);
        }
    } catch (err) {
        alert(`‚ùå Fel: ${err.message}`);
    }
}

async function optimizeForComfort() {
    if (!confirm('Optimera f√∂r maximal komfort?\n\nDetta justerar offset f√∂r att n√• 21¬∞C inomhus.')) {
        return;
    }

    try {
        const response = await fetch('/api/quick-action/optimize-comfort', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();

        if (result.success) {
            let msg = `‚úÖ ${result.message}`;
            if (result.changes && result.changes.length > 0) {
                msg += '\n\n√Ñndringar:';
                result.changes.forEach(c => {
                    msg += `\n‚Ä¢ ${c.parameter}: ${c.old_value} ‚Üí ${c.new_value}`;
                });
            }
            alert(msg);
            loadDashboard();
        } else {
            alert(`‚ùå ${result.error}`);
        }
    } catch (err) {
        alert(`‚ùå Fel: ${err.message}`);
    }
}
</script>
{% endblock %}
