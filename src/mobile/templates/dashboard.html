{% extends "base.html" %}

{% block title %}Dashboard - Nibe Autotuner{% endblock %}

{% block content %}
<!-- Loading indicator -->
<div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Laddar data...</p>
</div>

<!-- Error message -->
<div id="error" class="error" style="display: none;"></div>

<!-- Last updated -->
<div class="last-updated">
    <small>Uppdaterad: <span id="lastUpdate">-</span></small>
</div>

<!-- Optimization Score Banner -->
<section class="optimization-banner" id="optimizationBanner" style="display: none;">
    <div class="opt-score-container">
        <div class="opt-score-circle" id="optScoreCircle">
            <div class="opt-score-value" id="optScoreValue">-</div>
            <div class="opt-score-label">PoÃ¤ng</div>
        </div>
        <div class="opt-score-details">
            <div class="opt-score-badge" id="optScoreBadge">-</div>
            <div class="opt-score-subtitle">Systemets Ã¶vergripande prestanda</div>
        </div>
    </div>
</section>

<!-- Cost Analysis -->
<section class="section" id="costSection" style="display: none;">
    <h2 class="section-title">ğŸ’° Kostnadsanalys</h2>
    <div class="cost-grid">
        <div class="cost-card">
            <div class="cost-icon">ğŸ”¥</div>
            <div class="cost-label">UppvÃ¤rmning</div>
            <div class="cost-value" id="heatingCost">-</div>
            <div class="cost-detail" id="heatingCostDetail">-</div>
        </div>
        <div class="cost-card">
            <div class="cost-icon">ğŸ’§</div>
            <div class="cost-label">Varmvatten</div>
            <div class="cost-value" id="hotWaterCost">-</div>
            <div class="cost-detail" id="hotWaterCostDetail">-</div>
        </div>
        <div class="cost-card total">
            <div class="cost-icon">ğŸ’µ</div>
            <div class="cost-label">Total kostnad</div>
            <div class="cost-value" id="totalCost">-</div>
            <div class="cost-detail" id="totalCostDetail">-</div>
        </div>
    </div>
</section>

<!-- Main metrics -->
<section class="metrics-grid">
    <div class="metric-card highlight">
        <div class="metric-icon">âš¡</div>
        <div class="metric-value" id="cop">-</div>
        <div class="metric-label">COP</div>
        <div class="metric-status" id="copStatus"></div>
    </div>

    <div class="metric-card">
        <div class="metric-icon">ğŸ“</div>
        <div class="metric-value" id="degreeMinutes">-</div>
        <div class="metric-label">Gradminuter</div>
        <div class="metric-status" id="dmStatus"></div>
    </div>

    <div class="metric-card highlight">
        <div class="metric-icon">ğŸŒ¡ï¸</div>
        <div class="metric-value" id="deltaT">-</div>
        <div class="metric-label">Delta T (Aktiv)</div>
        <div class="metric-status" id="dtStatus"></div>
    </div>

    <div class="metric-card">
        <div class="metric-icon">âš™ï¸</div>
        <div class="metric-value" id="compressor">-</div>
        <div class="metric-label">Kompressor Hz</div>
    </div>
</section>

<!-- Temperatures -->
<section class="section">
    <h2 class="section-title">ğŸŒ¡ï¸ Temperaturer</h2>
    <div class="temp-grid">
        <div class="temp-item">
            <span class="temp-label">Ute</span>
            <span class="temp-value" id="outdoorTemp">-</span>
        </div>
        <div class="temp-item">
            <span class="temp-label">Inne</span>
            <span class="temp-value" id="indoorTemp">-</span>
        </div>
        <div class="temp-item">
            <span class="temp-label">Fram</span>
            <span class="temp-value" id="supplyTemp">-</span>
        </div>
        <div class="temp-item">
            <span class="temp-label">Retur</span>
            <span class="temp-value" id="returnTemp">-</span>
        </div>
    </div>
</section>

<!-- Delta T Breakdown -->
<section class="section">
    <h2 class="section-title">ğŸ“Š Delta T Analys</h2>
    <div class="delta-grid">
        <div class="delta-item">
            <div class="delta-label">UppvÃ¤rmning (Aktiv)</div>
            <div class="delta-value" id="deltaTActive">-</div>
            <div class="delta-status" id="deltaTActiveStatus"></div>
        </div>
        <div class="delta-item">
            <div class="delta-label">Varmvatten</div>
            <div class="delta-value" id="deltaTHotWater">-</div>
        </div>
    </div>
</section>

<!-- Separate Metrics: Heating vs Hot Water -->
<section class="section">
    <h2 class="section-title">ğŸ”¥ UppvÃ¤rmning vs ğŸ’§ Varmvatten</h2>

    <div class="comparison-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
        <!-- Heating Column -->
        <div class="comparison-column">
            <h3 style="color: var(--primary-color); text-align: center; margin-bottom: 0.5rem;">ğŸ”¥ UppvÃ¤rmning</h3>
            <div class="metric-card" id="heatingCard">
                <div class="metric-row">
                    <span class="metric-small-label">COP:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="heatingCOP">-</span>
                        <span class="performance-badge" id="heatingCOPBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Delta T:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="heatingDeltaT">-</span>
                        <span class="performance-badge" id="heatingDeltaTBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Runtime:</span>
                    <span class="metric-small-value" id="heatingRuntime">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Cykler:</span>
                    <span class="metric-small-value" id="heatingCycles">-</span>
                </div>
            </div>
        </div>

        <!-- Hot Water Column -->
        <div class="comparison-column">
            <h3 style="color: #ff5722; text-align: center; margin-bottom: 0.5rem;">ğŸ’§ Varmvatten</h3>
            <div class="metric-card" id="hotWaterCard">
                <div class="metric-row">
                    <span class="metric-small-label">COP:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="hotWaterCOP">-</span>
                        <span class="performance-badge" id="hotWaterCOPBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Delta T:</span>
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <span class="metric-small-value" id="hotWaterDeltaT">-</span>
                        <span class="performance-badge" id="hotWaterDeltaTBadge"></span>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">VV Temp:</span>
                    <span class="metric-small-value" id="hotWaterTemp">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Runtime:</span>
                    <span class="metric-small-value" id="hotWaterRuntime">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-small-label">Cykler:</span>
                    <span class="metric-small-value" id="hotWaterCycles">-</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- System Settings -->
<section class="section">
    <h2 class="section-title">âš™ï¸ SysteminstÃ¤llningar</h2>
    <div class="settings-grid">
        <div class="setting-item">
            <span class="setting-label">VÃ¤rmekurva</span>
            <span class="setting-value" id="heatingCurve">-</span>
        </div>
        <div class="setting-item">
            <span class="setting-label">Kurvjustering</span>
            <span class="setting-value" id="curveOffset">-</span>
        </div>
    </div>
</section>

<!-- Time period selector -->
<section class="section">
    <label for="timePeriod" class="form-label">Analysperiod:</label>
    <select id="timePeriod" class="form-select" onchange="loadDashboard()">
        <option value="1">Senaste timmen</option>
        <option value="6">Senaste 6 timmarna</option>
        <option value="24">Senaste 24 timmarna</option>
        <option value="72" selected>Senaste 3 dagarna</option>
        <option value="168">Senaste veckan</option>
    </select>
</section>

{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval = null;

async function loadDashboard() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const hours = document.getElementById('timePeriod').value;

    loading.style.display = 'block';
    error.style.display = 'none';

    try {
        const response = await fetch(`/api/metrics?hours=${hours}`);
        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error);
        }

        const data = result.data;

        // Update main metrics
        document.getElementById('cop').textContent = data.cop ? data.cop.toFixed(2) : 'N/A';
        document.getElementById('copStatus').textContent = data.cop && data.cop >= 3.0 ? 'âœ… UtmÃ¤rkt' : 'âš ï¸';

        document.getElementById('degreeMinutes').textContent = data.degree_minutes.toFixed(0);
        const dmOk = data.degree_minutes >= -300 && data.degree_minutes <= -100;
        document.getElementById('dmStatus').textContent = dmOk ? 'âœ…' : 'âš ï¸';

        if (data.delta_t_active) {
            document.getElementById('deltaT').textContent = data.delta_t_active.toFixed(1) + 'Â°C';
            const dtOk = data.delta_t_active >= 3 && data.delta_t_active <= 8;
            document.getElementById('dtStatus').textContent = dtOk ? 'âœ… Optimalt' : 'âš ï¸ Justera';
        } else {
            document.getElementById('deltaT').textContent = 'N/A';
            document.getElementById('dtStatus').textContent = '';
        }

        document.getElementById('compressor').textContent = data.avg_compressor_freq.toFixed(0) + ' Hz';

        // Update temperatures
        document.getElementById('outdoorTemp').textContent = data.avg_outdoor_temp.toFixed(1) + 'Â°C';
        document.getElementById('indoorTemp').textContent = data.avg_indoor_temp.toFixed(1) + 'Â°C';
        document.getElementById('supplyTemp').textContent = data.avg_supply_temp.toFixed(1) + 'Â°C';
        document.getElementById('returnTemp').textContent = data.avg_return_temp.toFixed(1) + 'Â°C';

        // Update Delta T breakdown
        if (data.delta_t_active) {
            document.getElementById('deltaTActive').textContent = data.delta_t_active.toFixed(1) + 'Â°C';
            const dtOk = data.delta_t_active >= 3 && data.delta_t_active <= 8;
            document.getElementById('deltaTActiveStatus').textContent = dtOk ? 'âœ… 3-8Â°C optimal' : 'âš ï¸ BÃ¶r vara 3-8Â°C';
        } else {
            document.getElementById('deltaTActive').textContent = 'N/A';
            document.getElementById('deltaTActiveStatus').textContent = 'Ingen aktiv uppvÃ¤rmning';
        }

        if (data.delta_t_hot_water) {
            document.getElementById('deltaTHotWater').textContent = data.delta_t_hot_water.toFixed(1) + 'Â°C';
        } else {
            document.getElementById('deltaTHotWater').textContent = 'N/A';
        }

        // Update settings
        document.getElementById('heatingCurve').textContent = data.heating_curve.toFixed(1);
        document.getElementById('curveOffset').textContent = data.curve_offset.toFixed(1);

        // Update separate heating metrics
        const heatingCard = document.getElementById('heatingCard');
        if (data.heating) {
            heatingCard.style.display = 'block';
            document.getElementById('heatingCOP').textContent = data.heating.cop ? data.heating.cop.toFixed(2) : 'N/A';
            document.getElementById('heatingDeltaT').textContent = data.heating.delta_t ? data.heating.delta_t.toFixed(1) + 'Â°C' : 'N/A';
            document.getElementById('heatingRuntime').textContent = data.heating.runtime_hours ? data.heating.runtime_hours.toFixed(1) + 'h' : 'N/A';
            document.getElementById('heatingCycles').textContent = data.heating.num_cycles || '0';

            // Set COP badge
            const copBadge = document.getElementById('heatingCOPBadge');
            if (data.heating.cop_rating) {
                copBadge.textContent = data.heating.cop_rating.badge;
                copBadge.style.backgroundColor = data.heating.cop_rating.color;
                copBadge.style.display = 'inline-block';
            }

            // Set Delta T badge
            const deltaTBadge = document.getElementById('heatingDeltaTBadge');
            if (data.heating.delta_t_rating) {
                deltaTBadge.textContent = data.heating.delta_t_rating.badge;
                deltaTBadge.style.backgroundColor = data.heating.delta_t_rating.color;
                deltaTBadge.style.display = 'inline-block';
            }
        } else {
            heatingCard.style.display = 'none';
        }

        // Update separate hot water metrics
        const hotWaterCard = document.getElementById('hotWaterCard');
        if (data.hot_water) {
            hotWaterCard.style.display = 'block';
            document.getElementById('hotWaterCOP').textContent = data.hot_water.cop ? data.hot_water.cop.toFixed(2) : 'N/A';
            document.getElementById('hotWaterDeltaT').textContent = data.hot_water.delta_t ? data.hot_water.delta_t.toFixed(1) + 'Â°C' : 'N/A';
            document.getElementById('hotWaterTemp').textContent = data.hot_water.avg_hot_water_temp ? data.hot_water.avg_hot_water_temp.toFixed(1) + 'Â°C' : 'N/A';
            document.getElementById('hotWaterRuntime').textContent = data.hot_water.runtime_hours ? data.hot_water.runtime_hours.toFixed(1) + 'h' : 'N/A';
            document.getElementById('hotWaterCycles').textContent = data.hot_water.num_cycles || '0';

            // Set COP badge
            const copBadge = document.getElementById('hotWaterCOPBadge');
            if (data.hot_water.cop_rating) {
                copBadge.textContent = data.hot_water.cop_rating.badge;
                copBadge.style.backgroundColor = data.hot_water.cop_rating.color;
                copBadge.style.display = 'inline-block';
            }

            // Set Delta T badge
            const deltaTBadge = document.getElementById('hotWaterDeltaTBadge');
            if (data.hot_water.delta_t_rating) {
                deltaTBadge.textContent = data.hot_water.delta_t_rating.badge;
                deltaTBadge.style.backgroundColor = data.hot_water.delta_t_rating.color;
                deltaTBadge.style.display = 'inline-block';
            }
        } else {
            hotWaterCard.style.display = 'none';
        }

        // Update timestamp
        const timestamp = new Date(data.timestamp);
        document.getElementById('lastUpdate').textContent = timestamp.toLocaleTimeString('sv-SE');

    } catch (err) {
        error.textContent = 'âŒ Fel vid laddning av data: ' + err.message;
        error.style.display = 'block';
        console.error('Error loading dashboard:', err);
    } finally {
        loading.style.display = 'none';
    }
}

function refreshData() {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('spinning');

    loadDashboard().finally(() => {
        setTimeout(() => icon.classList.remove('spinning'), 500);
    });
}

// Auto-refresh every 5 minutes
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    autoRefreshInterval = setInterval(loadDashboard, 5 * 60 * 1000);
}

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
    startAutoRefresh();
});

// Refresh when page becomes visible
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        loadDashboard();
    }
});
</script>
{% endblock %}
