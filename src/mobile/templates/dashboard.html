{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Top Status Row -->
    <div class="row g-2 mb-3">
        <!-- GM Bank -->
        <div class="col-6 col-md-3">
            <div class="card bg-dark text-white h-100 border-secondary shadow-sm">
                <div class="card-body text-center p-2">
                    <small class="text-muted text-uppercase" style="font-size:0.7rem;">GM Bank</small>
                    <div class="d-flex align-items-center justify-content-center mt-1">
                        <h2 class="mb-0 fw-bold" id="gm-balance">--</h2>
                    </div>
                    <span class="badge mt-1" id="gm-mode-badge">--</span>
                </div>
            </div>
        </div>
        
        <!-- Price -->
        <div class="col-6 col-md-3">
            <div class="card bg-dark text-white h-100 border-secondary shadow-sm">
                <div class="card-body text-center p-2">
                    <small class="text-muted text-uppercase" style="font-size:0.7rem;">Elpris</small>
                    <div class="d-flex align-items-center justify-content-center mt-1">
                        <h2 class="mb-0 fw-bold" id="current-price">--</h2>
                        <span class="ms-1 small text-muted">kr</span>
                    </div>
                    <small class="text-muted" style="font-size:0.7rem;">Spot: <span id="spot-price">--</span> kr</small>
                </div>
            </div>
        </div>

        <!-- Indoor -->
        <div class="col-6 col-md-3">
            <div class="card bg-dark text-white h-100 border-secondary shadow-sm">
                <div class="card-body text-center p-2">
                    <div class="d-flex justify-content-between px-2">
                        <small class="text-muted text-uppercase" style="font-size:0.6rem;">Nere</small>
                        <small class="text-muted text-uppercase" style="font-size:0.6rem;">Dexter</small>
                    </div>
                    <div class="d-flex align-items-center justify-content-around mt-1">
                        <h3 class="mb-0 fw-bold text-primary" id="indoor-temp">--</h3>
                        <div id="boost-indicator" class="d-none animate-pulse">
                            <i class="bi bi-fire text-danger" title="Dexter Boost Aktiv!"></i>
                        </div>
                        <h3 class="mb-0 fw-bold text-info" id="dexter-temp">--</h3>
                    </div>
                    <small class="text-success" style="font-size:0.7rem;">Mål: <span id="target-temp">--</span>°C</small>
                </div>
            </div>
        </div>

        <!-- Outdoor -->
        <div class="col-6 col-md-3">
            <div class="card bg-dark text-white h-100 border-secondary shadow-sm">
                <div class="card-body text-center p-2">
                    <small class="text-muted text-uppercase" style="font-size:0.7rem;">Ute / VV</small>
                    <div class="d-flex align-items-center justify-content-center mt-1">
                        <h2 class="mb-0 fw-bold" id="outdoor-temp">--</h2>
                        <span class="ms-1 small text-muted">°C</span>
                    </div>
                    <small class="text-info" style="font-size:0.7rem;">VV: <span id="hw-temp">--</span>°C</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chart: The Plan -->
    <div class="card bg-dark text-white mb-3 border-secondary shadow-sm">
        <div class="card-header border-secondary d-flex justify-content-between align-items-center py-2">
            <span class="fw-bold"><i class="bi bi-graph-up"></i> Historik & Plan (Multi-Zone)</span>
            <small id="last-updated-text" class="text-muted" style="font-size:0.7rem;">Laddar...</small>
        </div>
        <div class="card-body p-2" style="height: 350px; position: relative;">
            <canvas id="planChart"></canvas>
        </div>
    </div>

    <!-- Detailed Plan Table (Collapsible) -->
    <div class="accordion mb-4" id="planAccordion">
        <div class="accordion-item bg-dark border-secondary">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                    <i class="bi bi-list-ul me-2"></i> Visa Detaljerad Tabell (Multi-Zone)
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#planAccordion">
                <div class="accordion-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0" style="font-size: 0.85rem;">
                            <thead>
                                <tr class="text-muted">
                                    <th>Tid</th>
                                    <th>Värme</th>
                                    <th>VV</th>
                                    <th>Pris</th>
                                    <th>Nere</th>
                                    <th>Dexter</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body">
                                <tr><td colspan="6" class="text-center py-2">Laddar plan...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Log -->
    <div class="card bg-dark text-white mb-4 shadow-sm">
        <div class="card-header border-secondary">
            <span><i class="bi bi-activity"></i> Logg (Strategi)</span>
        </div>
        <div class="list-group list-group-flush list-group-dark" id="activity-log">
            <!-- Items injected by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
    let planChart = null;

    async function updateDashboard() {
        try {
            // 1. Status Data
            const sRes = await fetch('/api/status');
            if (!sRes.ok) throw new Error("Status API failed");
            const status = await sRes.json();
            
            const bal = status.gm_balance;
            const balEl = document.getElementById('gm-balance');
            balEl.innerText = bal !== undefined ? Math.round(bal) : '--';
            balEl.className = 'mb-0 fw-bold ' + (bal < -400 ? 'text-warning' : 'text-white');
            
            const badge = document.getElementById('gm-mode-badge');
            badge.innerText = status.gm_mode || '--';
            let badgeClass = 'bg-secondary';
            if (status.gm_mode === 'SPEND') badgeClass = 'bg-success';
            if (status.gm_mode === 'SAVE') badgeClass = 'bg-warning text-dark';
            badge.className = 'badge mt-1 ' + badgeClass;

            document.getElementById('current-price').innerText = status.current_price !== undefined ? status.current_price.toFixed(2) : '--';
            document.getElementById('spot-price').innerText = status.spot_price !== undefined ? status.spot_price.toFixed(2) : '--';
            document.getElementById('indoor-temp').innerText = status.indoor_temp !== null ? status.indoor_temp.toFixed(1) : '--';
            document.getElementById('dexter-temp').innerText = status.indoor_dexter !== null ? status.indoor_dexter.toFixed(1) : '--';
            document.getElementById('outdoor-temp').innerText = status.outdoor_temp !== null ? status.outdoor_temp : '--';
            document.getElementById('target-temp').innerText = status.target_temp;
            document.getElementById('hw-temp').innerText = status.hw_temp !== null ? status.hw_temp : '--';
            
            const boost = document.getElementById('boost-indicator');
            if (status.is_boost_active) boost.classList.remove('d-none');
            else boost.classList.add('d-none');

            document.getElementById('last-updated-text').innerText = 'Uppdaterad: ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            // 2. Plan Data
            const pRes = await fetch('/api/plan');
            if (pRes.ok) {
                const data = await pRes.json();
                renderChart(data);
                renderTable(data.table);
            }

            // 3. Log Data
            const logRes = await fetch('/api/ai-agent/history');
            if (logRes.ok) {
                const logs = await logRes.json();
                const logContainer = document.getElementById('activity-log');
                logContainer.innerHTML = '';
                if(logs && logs.length > 0) {
                    logs.slice(0, 5).forEach(log => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item bg-dark text-white border-secondary';
                        const time = new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">${time}</small>
                                <small class="badge bg-secondary">${log.action}</small>
                            </div>
                            <p class="mb-1 small">${log.reasoning || 'No details'}</p>
                        `;
                        logContainer.appendChild(item);
                    });
                } else {
                     logContainer.innerHTML = '<div class="p-3 text-center text-muted">Inga loggar</div>';
                }
            }

        } catch (e) {
            console.error("Dashboard update error:", e);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('schedule-table-body');
        tbody.innerHTML = '';
        if(!data || !data.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ingen plan tillgänglig</td></tr>';
            return;
        }

        data.forEach(row => {
            const tr = document.createElement('tr');
            const time = new Date(row.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let statusBadge = '<span class="badge bg-secondary">REST</span>';
            if (row.action === 'RUN' || row.action === 'MUST_RUN') statusBadge = '<span class="badge bg-success">RUN</span>';
            if (row.action === 'MUST_REST') statusBadge = '<span class="badge bg-danger">STOP</span>';
            
            let hwBadge = '<span class="badge bg-secondary">NORM</span>';
            if (row.hw_mode === 2) hwBadge = '<span class="badge bg-info text-dark">LUX</span>';
            if (row.hw_mode === 0) hwBadge = '<span class="badge bg-dark border border-secondary text-muted">ECO</span>';

            tr.innerHTML = `
                <td>${time}</td>
                <td>${statusBadge}</td>
                <td>${hwBadge}</td>
                <td>${row.price.toFixed(2)}</td>
                <td>${row.indoor_sim.toFixed(1)}°</td>
                <td class="text-info">${row.dexter_sim ? row.dexter_sim.toFixed(1) : '--'}°</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderChart(data) {
        if(!data || !data.history || !data.plan) return;
        const ctx = document.getElementById('planChart').getContext('2d');
        
        const indoorData = [...(data.history.indoor || []), ...data.plan.indoor];
        const dexterData = [...(data.history.dexter || []), ...data.plan.dexter];
        const outdoorData = [...(data.history.outdoor || []), ...data.plan.outdoor];
        const gmData = [...(data.history.gm || [])]; 
        const bankData = data.history.bank ? [...data.history.bank] : []; 
        const priceData = [...data.plan.price]; 
        const actionData = [...data.plan.action];

        if (planChart) {
            planChart.data.datasets[0].data = indoorData;
            planChart.data.datasets[1].data = dexterData;
            planChart.data.datasets[2].data = outdoorData;
            planChart.data.datasets[3].data = gmData;
            planChart.data.datasets[4].data = bankData;
            planChart.data.datasets[5].data = priceData;
            planChart.data.datasets[6].data = actionData;
            planChart.update();
            return;
        }

        planChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Nere °C',
                        data: indoorData,
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        yAxisID: 'yTemp',
                        pointRadius: 0,
                        tension: 0.2,
                        order: 1
                    },
                    {
                        label: 'Dexter °C',
                        data: dexterData,
                        borderColor: '#06b6d4', // Cyan
                        borderWidth: 2,
                        yAxisID: 'yTemp',
                        pointRadius: 0,
                        tension: 0.2,
                        order: 2
                    },
                    {
                        label: 'Ute °C',
                        data: outdoorData,
                        borderColor: '#6b7280', // Grey
                        borderWidth: 1,
                        yAxisID: 'yTemp',
                        pointRadius: 0,
                        tension: 0.2,
                        order: 3
                    },
                    {
                        label: 'GM (Pump)',
                        data: gmData,
                        borderColor: '#8b5cf6', // Lila
                        borderWidth: 1,
                        yAxisID: 'yGM',
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1,
                        order: 4
                    },
                    {
                        label: 'GM (Total Balans)', 
                        data: bankData,
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)', 
                        borderWidth: 0,
                        yAxisID: 'yGM',
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1,
                        order: 10 
                    },
                    {
                        label: 'Elpris (kr)',
                        data: priceData,
                        borderColor: '#facc15', // Yellow
                        borderWidth: 1,
                        borderDash: [5, 5],
                        yAxisID: 'yPrice',
                        pointRadius: 0,
                        tension: 0.1,
                        order: 5
                    },
                    {
                        label: 'Drift (PÅ)',
                        data: actionData,
                        type: 'bar',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        yAxisID: 'yAction',
                        barPercentage: 1.0,
                        categoryPercentage: 1.0,
                        order: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#ccc', usePointStyle: true, boxWidth: 8 } },
                    tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.9)' }
                },
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'hour', displayFormats:{hour:'HH:mm'} }, 
                        ticks: { color: '#6b7280', maxTicksLimit: 8 }, 
                        grid: { display: false } 
                    },
                    yTemp: { 
                        type: 'linear', position: 'left', 
                        ticks: { color: '#3b82f6' }, 
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    yGM: { 
                        type: 'linear', position: 'right', 
                        min: -800, max: 200, 
                        grid: { display: false },
                        display: false 
                    },
                    yPrice: { 
                        type: 'linear', position: 'right', 
                        ticks: { color: '#9ca3af' }, 
                        grid: { display: false },
                        min: 0 
                    },
                    yAction: { 
                        type: 'linear', position: 'right', display: false, min: 0, max: 20 
                    }
                }
            }
        });
    }

    updateDashboard();
    setInterval(updateDashboard, 60000);
</script>
{% endblock %}