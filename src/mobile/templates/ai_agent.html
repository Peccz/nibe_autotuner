{% extends "base.html" %}

{% block title %}AI-Agent - Nibe Autotuner{% endblock %}

{% block content %}
<!-- Loading indicator -->
<div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Laddar AI-data...</p>
</div>

<!-- Error message -->
<div id="error" class="error" style="display: none;"></div>

<div id="aiContent" style="display: none;">
    <div class="page-header">
        <h1>ü§ñ AI-Agent</h1>
        <p class="subtitle">Autonom optimering med Claude AI</p>
    </div>

    <!-- Status Card -->
    <div class="card">
        <div class="card-header">
            <h2>Status</h2>
            <span class="badge" id="statusBadge">-</span>
        </div>
        <div class="card-body">
            <div class="stat-row">
                <span class="stat-label">Senaste k√∂rning:</span>
                <span class="stat-value" id="lastRun">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">N√§sta k√∂rning:</span>
                <span class="stat-value" id="nextRun">Se CRON-schema</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Antal analyser:</span>
                <span class="stat-value" id="totalAnalyses">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Antal justeringar:</span>
                <span class="stat-value" id="totalAdjustments">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Kostnad denna m√•nad:</span>
                <span class="stat-value" id="monthlyCost">-</span>
            </div>
        </div>
    </div>

    <!-- Latest Decision -->
    <div class="card" id="latestDecisionCard" style="display: none;">
        <div class="card-header">
            <h2>Senaste Beslut</h2>
            <span class="timestamp" id="decisionTimestamp">-</span>
        </div>
        <div class="card-body">
            <div class="decision-header">
                <span class="decision-action" id="decisionAction">-</span>
                <span class="confidence-badge" id="decisionConfidence">-</span>
            </div>

            <div id="adjustmentDetails" style="display: none;">
                <div class="stat-row">
                    <span class="stat-label">Parameter:</span>
                    <span class="stat-value" id="decisionParameter">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">√Ñndring:</span>
                    <span class="stat-value" id="decisionChange">-</span>
                </div>
            </div>

            <div class="reasoning-box">
                <h3>Resonemang:</h3>
                <p id="decisionReasoning">-</p>
            </div>

            <div class="impact-box">
                <h3>F√∂rv√§ntad p√•verkan:</h3>
                <p id="decisionImpact">-</p>
            </div>
        </div>
    </div>

    <!-- Planned Tests -->
    <div class="card" id="plannedTestsCard" style="display: none;">
        <div class="card-header">
            <h2>Planerade Tester</h2>
            <span class="badge badge-info" id="plannedCount">0 st</span>
        </div>
        <div class="card-body" id="plannedTestsList">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Active Tests -->
    <div class="card" id="activeTestsCard" style="display: none;">
        <div class="card-header">
            <h2>P√•g√•ende Tester</h2>
            <span class="badge badge-warning" id="activeCount">0 aktiva</span>
        </div>
        <div class="card-body" id="activeTestsList">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Completed Tests -->
    <div class="card" id="completedTestsCard" style="display: none;">
        <div class="card-header">
            <h2>Genomf√∂rda Tester</h2>
            <span class="badge badge-secondary" id="completedCount">0 st</span>
        </div>
        <div class="card-body" id="completedTestsList">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Learning Statistics -->
    <div class="card">
        <div class="card-header">
            <h2>Inl√§rningsstatistik</h2>
        </div>
        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-content">
                        <div class="stat-value" id="successRate">-</div>
                        <div class="stat-label">Lyckandegrad</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <div class="stat-value" id="avgCopImprovement">-</div>
                        <div class="stat-label">Genomsnittlig COP-f√∂rb√§ttring</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-content">
                        <div class="stat-value" id="avgConfidence">-</div>
                        <div class="stat-label">Genomsnittlig konfidens</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîÑ</div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalTests">-</div>
                        <div class="stat-label">Totalt antal tester</div>
                    </div>
                </div>
            </div>

            <div id="bestFindingsSection" style="display: none;">
                <h3 style="margin-top: 1.5rem;">üèÜ B√§sta uppt√§ckter</h3>
                <div id="bestFindingsList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Automation Schedule -->
    <div class="card">
        <div class="card-header">
            <h2>Automatisering</h2>
        </div>
        <div class="card-body">
            <h3>Optimeringsschema</h3>
            <div class="schedule-item">
                <span class="schedule-icon">üåÖ</span>
                <div class="schedule-details">
                    <div class="schedule-time">05:00</div>
                    <div class="schedule-desc">Morgonanalys (genererar testf√∂rslag)</div>
                </div>
            </div>
            <div class="schedule-item">
                <span class="schedule-icon">üåÖ</span>
                <div class="schedule-details">
                    <div class="schedule-time">06:00</div>
                    <div class="schedule-desc">Morgonoptimering (ventilation & pump)</div>
                </div>
            </div>
            <div class="schedule-item">
                <span class="schedule-icon">üåô</span>
                <div class="schedule-details">
                    <div class="schedule-time">19:00</div>
                    <div class="schedule-desc">Kv√§llsoptimering (ventilation & pump)</div>
                </div>
            </div>

            <div class="schedule-settings">
                <p class="info-text">
                    AI-agenten analyserar systemet tv√• g√•nger per dag och justerar b√•de ventilation
                    och pumpinst√§llningar baserat p√• v√§der, prestanda och inl√§rda m√∂nster.
                </p>
                <p class="info-text">
                    <strong>S√§kerhetsregler:</strong>
                </p>
                <ul>
                    <li>Max 1 justering per 48h per parameter</li>
                    <li>Minst 70% konfidens kr√§vs f√∂r justeringar</li>
                    <li>Inomhustemperatur h√•lls alltid ‚â•20¬∞C</li>
                    <li>Minimum ventilation uppr√§tth√•lls f√∂r luftkvalitet</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Gemini AI Chat -->
    <div class="card">
        <div class="card-header">
            <h2>üí¨ Fr√•ga AI-agenten</h2>
        </div>
        <div class="card-body">
            <div id="chatMessages" class="chat-messages">
                <div class="chat-message ai-message">
                    <div class="message-content">
                        <strong>Gemini AI</strong>
                        <p>Hej! Jag √§r din AI-assistent. Fr√•ga mig om v√§rmepumpens prestanda, energibesparingar eller optimeringstips!</p>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Skriv din fr√•ga h√§r...">
                <button id="sendChatBtn" class="btn-send" onclick="sendChatMessage()">Skicka</button>
            </div>

            <div class="quick-questions">
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Snabbfr√•gor:</p>
                <button class="quick-question-btn" onclick="askQuickQuestion('Hur kan jag f√∂rb√§ttra COP?')">Hur kan jag f√∂rb√§ttra COP?</button>
                <button class="quick-question-btn" onclick="askQuickQuestion('Varf√∂r √§r gradminuterna h√∂ga?')">Varf√∂r √§r gradminuterna h√∂ga?</button>
                <button class="quick-question-btn" onclick="askQuickQuestion('Vad betyder Delta T?')">Vad betyder Delta T?</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Include all the styles from original ai_agent.html */
.decision-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.decision-action {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1.1rem;
}

.action-adjust {
    background: #4CAF50;
    color: white;
}

.action-hold {
    background: #FF9800;
    color: white;
}

.action-investigate {
    background: #2196F3;
    color: white;
}

.confidence-badge {
    background: #6c757d;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.9rem;
}

.reasoning-box, .impact-box {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.reasoning-box h3, .impact-box h3 {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 0 0 0.5rem 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-left: 4px solid var(--primary-color);
}

.stat-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.stat-content .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    color: var(--primary-color);
}

.stat-content .stat-label {
    font-size: 0.75rem;
    margin-top: 0.25rem;
    color: var(--text-secondary);
}

.schedule-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.schedule-icon {
    font-size: 2rem;
}

.schedule-time {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2d5f8e;
}

.schedule-desc {
    font-size: 0.9rem;
    color: #666;
}

.schedule-settings {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e0e0e0;
}

.info-text {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.6;
}

.info-text ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.info-text li {
    margin: 0.25rem 0;
}

.badge-info {
    background: #2196F3;
    color: white;
}

.badge-warning {
    background: #FF9800;
    color: white;
}

.badge-secondary {
    background: #6c757d;
    color: white;
}

.badge-success {
    background: #4CAF50;
    color: white;
}

/* Chat Styles */
.chat-messages {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.chat-message {
    margin-bottom: 1rem;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-message .message-content {
    background: var(--primary-color);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 12px 12px 4px 12px;
    margin-left: auto;
    max-width: 80%;
    text-align: right;
}

.ai-message .message-content {
    background: white;
    color: #333;
    padding: 0.75rem 1rem;
    border-radius: 12px 12px 12px 4px;
    max-width: 80%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.ai-message .message-content strong {
    color: var(--primary-color);
    display: block;
    margin-bottom: 0.25rem;
}

.chat-input-container {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.chat-input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

.btn-send {
    padding: 0.75rem 1.5rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}

.btn-send:hover {
    background: #5a67d8;
}

.btn-send:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.quick-questions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.quick-question-btn {
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.quick-question-btn:hover {
    background: #f8f9fa;
    border-color: var(--primary-color);
}

.typing-indicator {
    padding: 0.5rem;
    color: #666;
    font-style: italic;
}
</style>

<script>
async function loadAIData() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const content = document.getElementById('aiContent');

    loading.style.display = 'block';
    error.style.display = 'none';
    content.style.display = 'none';

    try {
        // Load all AI data in parallel
        const [statusRes, decisionRes, plannedRes, activeRes, completedRes, statsRes] = await Promise.all([
            fetch('/api/ai-agent/status'),
            fetch('/api/ai-agent/latest-decision'),
            fetch('/api/ai-agent/planned-tests'),
            fetch('/api/ai-agent/active-tests'),
            fetch('/api/ai-agent/completed-tests?limit=10'),
            fetch('/api/ai-agent/learning-stats')
        ]);

        const status = await statusRes.json();
        const decision = await decisionRes.json();
        const planned = await plannedRes.json();
        const active = await activeRes.json();
        const completed = await completedRes.json();
        const stats = await statsRes.json();

        // Update Status
        if (status.success) {
            const data = status.data;
            document.getElementById('statusBadge').textContent = data.enabled ? 'Aktiv' : 'Inaktiverad';
            document.getElementById('statusBadge').className = data.enabled ? 'badge badge-success' : 'badge badge-secondary';
            document.getElementById('lastRun').textContent = data.last_run ? new Date(data.last_run).toLocaleString('sv-SE') : 'Aldrig';
            document.getElementById('totalAnalyses').textContent = data.total_analyses;
            document.getElementById('totalAdjustments').textContent = data.total_adjustments;
            document.getElementById('monthlyCost').textContent = '~' + data.monthly_cost_sek.toFixed(2) + ' kr';
        }

        // Update Latest Decision
        if (decision.success && decision.data) {
            const dec = decision.data;
            const card = document.getElementById('latestDecisionCard');
            card.style.display = 'block';

            document.getElementById('decisionTimestamp').textContent = new Date(dec.timestamp).toLocaleString('sv-SE');

            const actionElem = document.getElementById('decisionAction');
            actionElem.textContent = dec.action === 'adjust' ? '‚öôÔ∏è Justering' : (dec.action === 'hold' ? '‚úã H√•ll' : 'üîç Unders√∂k');
            actionElem.className = 'decision-action action-' + dec.action;

            document.getElementById('decisionConfidence').textContent = Math.round(dec.confidence * 100) + '% konfidens';

            if (dec.action === 'adjust' && dec.parameter_name) {
                document.getElementById('adjustmentDetails').style.display = 'block';
                document.getElementById('decisionParameter').textContent = dec.parameter_name;
                document.getElementById('decisionChange').textContent = dec.old_value + ' ‚Üí ' + dec.new_value;
            }

            document.getElementById('decisionReasoning').textContent = dec.reasoning || 'Ingen information';
            document.getElementById('decisionImpact').textContent = dec.expected_impact || 'Ingen information';
        }

        // Update Planned Tests
        if (planned.success && planned.data.length > 0) {
            const card = document.getElementById('plannedTestsCard');
            card.style.display = 'block';
            document.getElementById('plannedCount').textContent = planned.data.length + ' st';

            const html = planned.data.map(test => `
                <div class="test-item" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>${test.parameter_name}</strong>
                        <span style="padding: 0.25rem 0.5rem; background: ${test.priority === 'high' ? '#f44336' : (test.priority === 'medium' ? '#ff9800' : '#4caf50')}; color: white; border-radius: 4px; font-size: 0.8rem;">${test.priority.toUpperCase()}</span>
                    </div>
                    <p><strong>Hypotes:</strong> ${test.hypothesis}</p>
                    <p><strong>F√∂rv√§ntad f√∂rb√§ttring:</strong> ${test.expected_improvement}</p>
                    <p><strong>Konfidens:</strong> ${test.confidence}%</p>
                </div>
            `).join('');
            document.getElementById('plannedTestsList').innerHTML = html;
        }

        // Update Learning Stats
        if (stats.success) {
            const data = stats.data;
            document.getElementById('successRate').textContent = Math.round(data.success_rate) + '%';
            document.getElementById('avgCopImprovement').textContent = data.avg_cop_improvement.toFixed(1) + '%';
            document.getElementById('avgConfidence').textContent = Math.round(data.avg_confidence) + '%';
            document.getElementById('totalTests').textContent = data.total_tests;

            if (data.best_findings && data.best_findings.length > 0) {
                document.getElementById('bestFindingsSection').style.display = 'block';
                const html = data.best_findings.map(finding => `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>${finding.parameter_name}</strong>
                            <span style="color: #4CAF50; font-weight: 700;">+${finding.improvement.toFixed(1)}% COP</span>
                        </div>
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">${finding.description}</p>
                    </div>
                `).join('');
                document.getElementById('bestFindingsList').innerHTML = html;
            }
        }

        content.style.display = 'block';

    } catch (err) {
        error.textContent = '‚ùå Fel vid laddning av AI-data: ' + err.message;
        error.style.display = 'block';
        console.error('Error loading AI data:', err);
    } finally {
        loading.style.display = 'none';
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadAIData);

// ========== GEMINI CHAT FUNCTIONS ==========

let conversationHistory = [];

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();

    if (!message) return;

    // Add user message to chat
    addMessageToChat('user', message);

    // Clear input and disable button
    input.value = '';
    const sendBtn = document.getElementById('sendChatBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = '...';

    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.textContent = 'AI t√§nker...';
    document.getElementById('chatMessages').appendChild(typingDiv);
    scrollChatToBottom();

    try {
        // If this is the first message, fetch system data first
        let historyToSend = conversationHistory;

        if (conversationHistory.length === 0) {
            try {
                const metricsRes = await fetch('/api/metrics?hours=24');
                const metricsData = await metricsRes.json();

                if (metricsData.success) {
                    const m = metricsData.data;
                    const systemPrompt = `SYSTEMKONFIGURATION:
V√§rmepump: Nibe F730 - Fr√•nluftsv√§rmepump
Hus: 3 v√•ningar, 160 m¬≤
  - Bottenv√•ning: Golvv√§rme i platta med shuntgrupp
  - V√•ning 2 & 3: Radiatorer
V√§rmesystem:
  - Golvv√§rme: Shunt, fl√∂de och pumphastighet justerbart
  - Alla termostater: Helt √∂ppna (ingen zonreglering)
  - Golvv√§rme-slingor: Termostater alltid √∂ppna
  - Radiatorer: Termostater alltid √∂ppna
Givare:
  - Utomhusgivare: V√§stl√§ge (solp√•verkan eftermiddag/kv√§ll)
  - Inomhusgivare: Trapphus bottenplan (kan vara kallare √§n bostadsrum)
  - OBS: Uppm√§tta temperaturer kan vara l√§gre √§n verklig boendetemperatur
  - Temperatur v√•ning 2 & 3: Manuell avl√§sning m√∂jlig
Varmvatten: Via v√§rmepump
Styrning: MyUplink API via nibe_autotuner
AI-system: Autonomt l√§rande med A/B-tester

TILLG√ÑNGLIGA PARAMETRAR:
- 47011: Room temp setpoint (14-30¬∞C) - M√•ltemperatur rumssensor
- 47041: Room sensor factor (0-10) - Rumssensorns p√•verkan
- 47015: Room temp setpoint S4 (5-30¬∞C) - Extra v√§rmebehov
- 47007: Offset S4 (-10 till +10¬∞C) - Kurvf√∂rskjutning
- 47020: Min supply temp (-10 till +30¬∞C) - L√§gsta framledningstemp
- 47019: Max supply temp (20-70¬∞C) - H√∂gsta framledningstemp
- 43437: Cirkulationspump GP1 (%) - Pumphastighet

AKTUELL PRESTANDA (senaste 24h):
COP: ${m.cop ? m.cop.toFixed(2) : 'N/A'}
Gradminuter: ${m.degree_minutes ? m.degree_minutes.toFixed(1) : 'N/A'}
Delta T: ${m.delta_t_active ? m.delta_t_active.toFixed(1) : 'N/A'}¬∞C
Inne: ${m.room_temp ? m.room_temp.toFixed(1) : 'N/A'}¬∞C
Ute: ${m.outdoor_temp ? m.outdoor_temp.toFixed(1) : 'N/A'}¬∞C
Framledning: ${m.supply_temp ? m.supply_temp.toFixed(1) : 'N/A'}¬∞C
Retur: ${m.return_temp ? m.return_temp.toFixed(1) : 'N/A'}¬∞C

OPTIMERINGSM√ÖL:
1. Maximera COP (m√•l: >3.0)
2. Minimera gradminuter (m√•l: <100)
3. H√•ll komfort (20-22¬∞C inne)
4. Optimera Delta T (optimalt: 5-7¬∞C)

Analysera denna data och svara p√• anv√§ndarens fr√•ga med konkreta, actionerbara r√•d.`;

                    historyToSend = [{ role: 'system', content: systemPrompt }];
                }
            } catch (e) {
                console.warn('Could not fetch metrics:', e);
            }
        } else {
            // For follow-up messages, keep system prompt but limit conversation history
            // Keep first message (system prompt) + last 8 messages (4 exchanges)
            const systemMsg = conversationHistory.find(m => m.role === 'system');
            const userMessages = conversationHistory.filter(m => m.role !== 'system');

            if (systemMsg && userMessages.length > 8) {
                // Keep system prompt + last 8 user/assistant messages
                historyToSend = [systemMsg, ...userMessages.slice(-8)];
            }
        }

        const response = await fetch('/api/gemini/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                history: historyToSend
            })
        });

        const data = await response.json();

        // Remove typing indicator
        document.getElementById('typingIndicator')?.remove();

        if (data.success) {
            addMessageToChat('ai', data.response);

            // Update conversation history
            conversationHistory.push({ role: 'user', content: message });
            conversationHistory.push({ role: 'assistant', content: data.response });

            // Keep system prompt + last 10 user/assistant messages (5 exchanges)
            const systemMsg = conversationHistory.find(m => m.role === 'system');
            const userMessages = conversationHistory.filter(m => m.role !== 'system');

            if (userMessages.length > 10) {
                conversationHistory = systemMsg
                    ? [systemMsg, ...userMessages.slice(-10)]
                    : userMessages.slice(-10);
            }
        } else {
            addMessageToChat('ai', '‚ùå ' + (data.error || 'Ett fel uppstod'));
        }

    } catch (error) {
        document.getElementById('typingIndicator')?.remove();
        addMessageToChat('ai', '‚ùå Kunde inte kontakta AI-agenten: ' + error.message);
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Skicka';
    }
}

function addMessageToChat(role, content) {
    const messagesDiv = document.getElementById('chatMessages');

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}-message`;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    if (role === 'ai') {
        const strong = document.createElement('strong');
        strong.textContent = 'Gemini AI';
        contentDiv.appendChild(strong);
    }

    const p = document.createElement('p');
    p.textContent = content;
    p.style.margin = '0';
    contentDiv.appendChild(p);

    messageDiv.appendChild(contentDiv);
    messagesDiv.appendChild(messageDiv);

    scrollChatToBottom();
}

function scrollChatToBottom() {
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function askQuickQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendChatMessage();
}

// Enable sending message with Enter key
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }
});
</script>
{% endblock %}
